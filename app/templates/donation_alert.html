{% extends "base.html" %}
{% block title %}Донейт алерт - DonAlert{% endblock %}
{% block body_class %}dashboard-page{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/donation-alert.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    {% include 'components/sidebar.html' %}

    <div class="dashboard-content">
        <div class="glass-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Донейт алерт тохиргоо</h2>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="testAlert()">
                        <i class="fas fa-play me-1"></i>Туршилт
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="copyOverlayUrl(event)">
                        <i class="fas fa-copy me-1"></i>Overlay URL
                    </button>
                </div>
            </div>

            <!-- Alert Tabs (Advanced Tier Only) -->
            {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
            <div class="alert-tabs-container mb-4">
                <ul class="nav nav-tabs alert-tabs" id="alertTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="alert-1-tab" data-bs-toggle="tab" data-bs-target="#alert-1" 
                                type="button" role="tab" aria-controls="alert-1" aria-selected="true">
                            <i class="fas fa-bell me-1"></i>Алерт 1 (₮0+)
                        </button>
                    </li>
                    <li class="nav-item add-tab-item" role="presentation">
                        <button class="nav-link add-tab-btn" type="button" onclick="addNewAlertTab()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </li>
                </ul>
            </div>

            <!-- Advanced Tier - Tabbed Content -->
            <div class="tab-content" id="alertTabContent">
                <!-- Tab 1 (Default Alert) -->
                <div class="tab-pane fade show active" id="alert-1" role="tabpanel" aria-labelledby="alert-1-tab">
                    <div class="row">
                        <!-- Settings Panel -->
                        <div class="col-xl-7 col-lg-7">
                            <form id="alertSettingsForm">
                                {% include 'components/alert_settings_form.html' %}
                                
                                <!-- Save Button -->
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Тохиргоо хадгалах
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Live Preview Panel -->
                        <div class="col-xl-5 col-lg-5">
                            <div class="glass-card p-3 sticky-top">
                                <h5 class="mb-3"><i class="fas fa-eye me-2"></i>Урьдчилан үзэх</h5>
                                
                                <div id="alertPreview" class="alert-preview-container">
                                    <div class="preview-background">
                                        <div id="previewAlert" class="donation-alert" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
                                            <!-- Preview content will be generated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Browser Audio Policy Warning -->
                                <div class="alert alert-warning mt-3 py-2" style="font-size: 0.85rem;">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Анхааруулга:</strong> Google Chrome зэрэг зарим хөтөч нь хуудастай эхлээд харилцах хэрэгтэй байдаг тул дуу автоматаар тоглохгүй байж болно. Энэ асуудал OBS дээр тохиолдохгүй.
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Basic Tier - Direct Content (No Tabs) -->
            {% if not (current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced') %}
            <div class="row">
                <!-- Settings Panel -->
                <div class="col-xl-7 col-lg-7">
                    <form id="alertSettingsForm">
                        {% include 'components/alert_settings_form.html' %}
                        
                        <!-- Save Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Тохиргоо хадгалах
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Live Preview Panel -->
                <div class="col-xl-5 col-lg-5">
                    <div class="glass-card p-3 sticky-top">
                        <h5 class="mb-3"><i class="fas fa-eye me-2"></i>Урьдчилан үзэх</h5>
                        
                        <div id="alertPreview" class="alert-preview-container">
                            <div class="preview-background">
                                <div id="previewAlert" class="donation-alert" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
                                    <!-- Preview content will be generated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Browser Audio Policy Warning -->
                        <div class="alert alert-warning mt-3 py-2" style="font-size: 0.85rem;">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Анхааруулга:</strong> Google Chrome зэрэг зарим хөтөч нь хуудастай эхлээд харилцах хэрэгтэй байдаг тул дуу автоматаар тоглохгүй байж болно. Энэ асуудал OBS дээр тохиолдохгүй.
                        </div>

                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Asset Selection Modal -->
<div class="modal fade" id="assetModal" tabindex="-1" aria-labelledby="assetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px;">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="assetModalLabel">Зураг сонгох</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Upload Section -->
                    <div class="col-12 mb-4">
                        <div class="glass-card p-3">
                            <h6 class="mb-3"><i class="fas fa-upload me-2"></i>Шинэ файл нэмэх</h6>
                            <div class="upload-area" onclick="triggerFileUpload()" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                                <p class="mb-2"><strong>Файл сонгох эсвэл энд чирж оруулах</strong></p>
                                <p class="text-muted small">Зөвшөөрөгдсөн файл: <span id="allowedTypes"></span></p>
                                <p class="text-muted small">Хамгийн их хэмжээ: <span id="maxSize"></span></p>
                            </div>
                            <input type="file" id="modalFileUpload" style="display: none;" onchange="uploadAssetFromModal(this.files[0])">
                        </div>
                    </div>
                    
                    <!-- Asset Gallery -->
                    <div class="col-12">
                        <div class="row" id="assetTabs">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100 mb-3" id="userAssetsTab" onclick="switchAssetTab('user')" style="height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user me-2"></i>Миний файлууд (<span id="userAssetCount">0</span>)
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100 mb-3" id="defaultAssetsTab" onclick="switchAssetTab('default')" style="height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-star me-2"></i>Үндсэн файлууд (<span id="defaultAssetCount">0</span>)
                                </button>
                            </div>
                        </div>
                        
                        <div class="asset-modal-gallery" id="modalAssetGallery">
                            <!-- Assets will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Цуцлах</button>
                <button type="button" class="btn btn-primary" onclick="confirmAssetSelection()" id="confirmSelectBtn" disabled>Сонгох</button>
            </div>
        </div>
    </div>
</div>


<script>
// Current settings
let currentSettings = {{ settings.to_dict() | tojson }};

// Per-tab asset selections - stores selections for each tab
let tabAssetSelections = {
    1: { // Default tab
        selectedGif: null,
        selectedSound: null
    }
};

// Global fallback for basic tier
let selectedGif = null;
let selectedSound = null;

// Alert tabs management
let alertTabCounter = 1;
let maxAlertTabs = 5; // Maximum number of alert tabs allowed
let currentActiveTab = 1; // Track which tab is currently active

// Asset data for modal
window.userGifs = {{ user_gifs | tojson }};
window.userSounds = {{ user_sounds | tojson }};
window.defaultGifs = {{ default_gifs | tojson }};
window.defaultSounds = {{ default_sounds | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize asset selections
    initializeAssetSelections();
    
    // Initialize range displays
    updateRangeDisplay('imageSize', 'imageSizeDisplay', '%');
    updateRangeDisplay('soundVolume', 'soundVolumeDisplay', '%');
    
    // Add event listeners for live preview
    document.getElementById('alertSettingsForm').addEventListener('input', updatePreview);
    document.getElementById('alertSettingsForm').addEventListener('change', updatePreview);
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Add real-time minimum amount updates for tab labels
    function setupMinimumAmountListeners() {
        const forms = document.querySelectorAll('form[id^="alertSettingsForm"]');
        forms.forEach(form => {
            const minimumAmountInput = form.querySelector('[name="minimum_amount"]');
            if (minimumAmountInput) {
                minimumAmountInput.addEventListener('input', function() {
                    const tabNumber = getCurrentActiveTabNumber();
                    const value = parseFloat(this.value) || 0;
                    updateTabLabel(tabNumber, value);
                });
            }
        });
    }
    
    // Initial setup for existing forms
    setupMinimumAmountListeners();
    {% endif %}
    
    // Initial preview
    updatePreview();
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Initialize tab 1 with current settings
    if (currentSettings) {
        // Update tab label
        if (currentSettings.minimum_amount !== undefined) {
            updateTabLabel(1, currentSettings.minimum_amount);
        }
        
        // Load tab 1 assets from initial settings - ensure to pass the complete config
        console.log('Initializing tab 1 with settings:', currentSettings);
        populateTabForm(1, currentSettings);
    }
    
    // Initialize configurations from backend data
    {% if alert_configurations %}
    console.log('Initializing from alert_configurations:', {{ alert_configurations | tojson }});
    // Load each configuration if they exist
    const configs = {{ alert_configurations | tojson }};
    configs.forEach(config => {
        if (config.tab_number === 1) {
            // Make sure tab 1 gets its saved configuration
            console.log('Loading saved config for tab 1:', config);
            populateTabForm(1, config);
        }
    });
    {% endif %}
    
    // Add event listeners for tab switching to load configurations
    document.addEventListener('shown.bs.tab', function(event) {
        const tabId = event.target.getAttribute('data-bs-target');
        if (tabId && tabId.startsWith('#alert-')) {
            const tabNumber = parseInt(tabId.replace('#alert-', ''));
            loadTabConfiguration(tabNumber);
        }
    });
    {% endif %}
});

// Helper functions for tab management
function getCurrentActiveTabNumber() {
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        const tabId = activeTab.id;
        const tabNumber = parseInt(tabId.replace('alert-', ''));
        return tabNumber;
    }
    {% endif %}
    return 1; // Default for basic tier or fallback
}

function getCurrentTabAssets() {
    const tabNumber = getCurrentActiveTabNumber();
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    if (!tabAssetSelections[tabNumber]) {
        tabAssetSelections[tabNumber] = { selectedGif: null, selectedSound: null };
    }
    return tabAssetSelections[tabNumber];
    {% else %}
    return { selectedGif: selectedGif, selectedSound: selectedSound };
    {% endif %}
}

function setCurrentTabAssets(gif, sound) {
    const tabNumber = getCurrentActiveTabNumber();
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    if (!tabAssetSelections[tabNumber]) {
        tabAssetSelections[tabNumber] = { selectedGif: null, selectedSound: null };
    }
    if (gif !== undefined) tabAssetSelections[tabNumber].selectedGif = gif;
    if (sound !== undefined) tabAssetSelections[tabNumber].selectedSound = sound;
    {% else %}
    if (gif !== undefined) selectedGif = gif;
    if (sound !== undefined) selectedSound = sound;
    {% endif %}
}

// Load configuration for specific tab
function loadTabConfiguration(tabNumber) {
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    if (tabNumber === 1) {
        // Tab 1 loads from the initial page data, no need to fetch
        return;
    }
    
    fetch(`/donation-alert/configurations/${tabNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.configuration) {
                populateTabForm(tabNumber, data.configuration);
            } else {
                console.log('No configuration found for tab', tabNumber, 'using defaults');
                // Tab will use default values from the form
            }
        })
        .catch(error => {
            console.error('Error loading tab configuration:', error);
        });
    {% endif %}
}

function populateTabForm(tabNumber, config) {
    const tabPane = document.getElementById(`alert-${tabNumber}`);
    if (!tabPane) return;
    
    console.log('=== POPULATING TAB FORM ===');
    console.log('Tab number:', tabNumber);
    console.log('Configuration:', config);
    
    // Populate form fields
    Object.keys(config).forEach(key => {
        const input = tabPane.querySelector(`[name="${key}"]`);
        if (input) {
            if (input.type === 'checkbox') {
                input.checked = config[key];
            } else if (input.type === 'range') {
                input.value = config[key];
                // Update range display
                const displayId = input.id.replace(/(_tab\d+)?$/, 'Display').replace('_tab', '');
                const display = tabPane.querySelector(`#${displayId}, [id$="${displayId}"]`);
                if (display) {
                    const unit = input.id.includes('Size') ? '%' : (input.id.includes('Volume') ? '%' : '');
                    display.textContent = config[key] + unit;
                }
            } else {
                // Convert milliseconds back to seconds for UI
                if (key === 'visible_time' || key === 'animation_speed') {
                    input.value = (config[key] / 1000).toFixed(1);
                } else {
                    input.value = config[key];
                }
            }
        }
    });
    
    // Load assets for this tab
    console.log('Loading assets for tab', tabNumber);
    console.log('GIF - ID:', config.selected_gif_id, 'Name:', config.default_gif_name);
    console.log('Sound - ID:', config.selected_sound_id, 'Name:', config.default_sound_name);
    
    if (config.selected_gif_id || config.default_gif_name) {
        // Find and set the GIF asset
        let gifAsset = null;
        if (config.selected_gif_id) {
            gifAsset = window.userGifs.find(gif => gif.id === config.selected_gif_id);
        } else if (config.default_gif_name) {
            gifAsset = window.defaultGifs.find(gif => gif.filename === config.default_gif_name);
            if (gifAsset) gifAsset.is_default = true;
        }
        
        if (gifAsset) {
            if (!tabAssetSelections[tabNumber]) {
                tabAssetSelections[tabNumber] = { selectedGif: null, selectedSound: null };
            }
            console.log('Loading GIF asset for tab', tabNumber, ':', gifAsset);
            tabAssetSelections[tabNumber].selectedGif = gifAsset;
        }
    }
    
    if (config.selected_sound_id || config.default_sound_name) {
        // Find and set the sound asset
        let soundAsset = null;
        if (config.selected_sound_id) {
            soundAsset = window.userSounds.find(sound => sound.id === config.selected_sound_id);
        } else if (config.default_sound_name) {
            soundAsset = window.defaultSounds.find(sound => sound.filename === config.default_sound_name);
            if (soundAsset) soundAsset.is_default = true;
        }
        
        if (soundAsset) {
            if (!tabAssetSelections[tabNumber]) {
                tabAssetSelections[tabNumber] = { selectedGif: null, selectedSound: null };
            }
            tabAssetSelections[tabNumber].selectedSound = soundAsset;
        }
    }
    
    // Update asset previews for this tab
    updateAssetPreviews(tabNumber);
    
    // Update tab label with minimum amount
    updateTabLabel(tabNumber, config.minimum_amount || 0);
    
    // Update preview
    updatePreview();
}

function updateAssetPreviews(tabNumber) {
    const tabPane = document.getElementById(`alert-${tabNumber}`);
    if (!tabPane) return;
    
    const assets = tabAssetSelections[tabNumber];
    if (!assets) return;
    
    // Update GIF preview
    const gifPreview = tabPane.querySelector('[id^="selectedGifPreview"]');
    const gifImage = tabPane.querySelector('[id^="selectedGifImage"]');
    const gifName = tabPane.querySelector('[id^="selectedGifName"]');
    
    if (assets.selectedGif && gifPreview && gifImage && gifName) {
        gifImage.src = assets.selectedGif.url;
        gifImage.style.display = 'block';
        gifName.textContent = assets.selectedGif.display_name || assets.selectedGif.filename;
    }
    
    // Update sound preview
    const soundPreview = tabPane.querySelector('[id^="selectedSoundPreview"]');
    const soundIcon = tabPane.querySelector('[id^="selectedSoundIcon"]');
    const soundName = tabPane.querySelector('[id^="selectedSoundName"]');
    const playBtn = tabPane.querySelector('[id^="playSoundBtn"]');
    
    if (assets.selectedSound && soundPreview && soundIcon && soundName && playBtn) {
        soundIcon.style.display = 'inline';
        soundName.textContent = assets.selectedSound.display_name || assets.selectedSound.filename;
        playBtn.style.display = 'inline-block';
    }
}

function updateTabLabel(tabNumber, minimumAmount) {
    const tabButton = document.getElementById(`alert-${tabNumber}-tab`);
    if (!tabButton) return;
    
    const formattedAmount = minimumAmount > 0 ? `₮${minimumAmount.toLocaleString()}+` : '₮0+';
    const icon = tabButton.querySelector('i');
    const closeBtn = tabButton.querySelector('.btn-close');
    
    // Update the tab text while preserving the icon and close button
    const iconHTML = icon ? icon.outerHTML : '<i class="fas fa-bell me-1"></i>';
    const closeBtnHTML = closeBtn ? closeBtn.outerHTML : '';
    
    tabButton.innerHTML = `${iconHTML}Алерт ${tabNumber} (${formattedAmount})${closeBtnHTML}`;
}

// Tab Management Functions
function addNewAlertTab() {
    if (alertTabCounter >= maxAlertTabs) {
        alert('Хамгийн ихдээ ' + maxAlertTabs + ' алерт нэмж болно.');
        return;
    }
    
    alertTabCounter++;
    const tabId = 'alert-' + alertTabCounter;
    const tabLabel = 'Алерт ' + alertTabCounter;
    
    // Initialize asset selections for new tab
    tabAssetSelections[alertTabCounter] = {
        selectedGif: null,
        selectedSound: null
    };
    
    // Create new tab button
    const tabsList = document.getElementById('alertTabs');
    const addTabItem = tabsList.querySelector('.add-tab-item');
    
    const newTabItem = document.createElement('li');
    newTabItem.className = 'nav-item';
    newTabItem.setAttribute('role', 'presentation');
    newTabItem.innerHTML = `
        <button class="nav-link" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" 
                type="button" role="tab" aria-controls="${tabId}" aria-selected="false">
            <i class="fas fa-bell me-1"></i>${tabLabel} (₮0+)
            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 10px;" onclick="removeAlertTab('${tabId}', event)"></button>
        </button>
    `;
    
    // Insert before the add button
    tabsList.insertBefore(newTabItem, addTabItem);
    
    // Create new tab content
    const tabContent = document.getElementById('alertTabContent');
    const newTabPane = document.createElement('div');
    newTabPane.className = 'tab-pane fade';
    newTabPane.id = tabId;
    newTabPane.setAttribute('role', 'tabpanel');
    newTabPane.setAttribute('aria-labelledby', tabId + '-tab');
    
    // Clone the first tab's content structure
    const firstTab = document.getElementById('alert-1');
    newTabPane.innerHTML = firstTab.innerHTML;
    
    // Update form IDs to make them unique
    updateTabFormIds(newTabPane, alertTabCounter);
    
    tabContent.appendChild(newTabPane);
    
    // Activate the new tab
    const newTab = new bootstrap.Tab(document.getElementById(tabId + '-tab'));
    newTab.show();
    
    // Update current active tab
    currentActiveTab = alertTabCounter;
    
    console.log('Added new alert tab:', tabLabel);
}

function removeAlertTab(tabId, event) {
    event.stopPropagation();
    
    if (tabId === 'alert-1') {
        alert('Үндсэн алерт устгах боломжгүй.');
        return;
    }
    
    if (confirm('Та энэ алертыг устгахыг хүсэж байна уу?')) {
        const tabNumber = parseInt(tabId.replace('alert-', ''));
        
        // Call backend API to delete configuration
        {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
        fetch(`/donation-alert/configurations/${tabNumber}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove tab button
                const tabButton = document.getElementById(tabId + '-tab');
                if (tabButton) {
                    tabButton.closest('.nav-item').remove();
                }
                
                // Remove tab content
                const tabPane = document.getElementById(tabId);
                if (tabPane) {
                    tabPane.remove();
                }
                
                // Remove from asset selections
                delete tabAssetSelections[tabNumber];
                
                // Activate first tab if the removed tab was active
                const firstTabButton = document.getElementById('alert-1-tab');
                if (firstTabButton && !document.querySelector('.nav-link.active')) {
                    const firstTab = new bootstrap.Tab(firstTabButton);
                    firstTab.show();
                }
                
                console.log('Removed alert tab:', tabId);
            } else {
                alert('Алдаа гарлаа: ' + (data.error || 'Тодорхойгүй алдаа'));
            }
        })
        .catch(error => {
            alert('Холболтын алдаа гарлаа');
            console.error('Error removing tab:', error);
        });
        {% endif %}
    }
}

function updateTabFormIds(tabElement, tabNumber) {
    // Update form and input IDs to make them unique for each tab
    const form = tabElement.querySelector('form');
    if (form) {
        form.id = 'alertSettingsForm' + tabNumber;
    }
    
    // Update all input IDs and their corresponding labels
    const inputs = tabElement.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.id) {
            const newId = input.id + '_tab' + tabNumber;
            const oldId = input.id;
            input.id = newId;
            
            // Update corresponding label
            const label = tabElement.querySelector(`label[for="${oldId}"]`);
            if (label) {
                label.setAttribute('for', newId);
            }
        }
    });
    
    // Update preview container ID
    const previewAlert = tabElement.querySelector('#previewAlert');
    if (previewAlert) {
        previewAlert.id = 'previewAlert' + tabNumber;
    }
    
    // Add event listeners for this tab's form
    const tabForm = tabElement.querySelector('form');
    if (tabForm) {
        tabForm.addEventListener('input', updatePreview);
        tabForm.addEventListener('change', updatePreview);
    }
}

function initializeAssetSelections() {
    // Initialize GIF selection and preview from current settings
    if (currentSettings.selected_gif_id) {
        // Set selectedGif from user asset
        selectedGif = {
            id: currentSettings.selected_gif_id,
            url: currentSettings.gif_url,
            is_default: false
        };
        
        // Update preview directly from settings
        const previewImg = document.getElementById('selectedGifImage');
        const previewName = document.getElementById('selectedGifName');
        previewImg.src = currentSettings.gif_url;
        previewImg.style.display = 'block';
        previewName.textContent = 'Сонгосон зураг'; // Selected image
        
    } else if (currentSettings.default_gif_name) {
        // Set selectedGif from default asset
        selectedGif = {
            filename: currentSettings.default_gif_name,
            url: currentSettings.gif_url,
            is_default: true
        };
        
        // Update preview directly from settings
        const previewImg = document.getElementById('selectedGifImage');
        const previewName = document.getElementById('selectedGifName');
        previewImg.src = currentSettings.gif_url;
        previewImg.style.display = 'block';
        previewName.textContent = currentSettings.default_gif_name;
    }
    
    // Initialize Sound selection and preview from current settings
    if (currentSettings.selected_sound_id) {
        // Set selectedSound from user asset
        selectedSound = {
            id: currentSettings.selected_sound_id,
            url: currentSettings.sound_url,
            is_default: false
        };
        
        // Update preview directly from settings
        const previewIcon = document.getElementById('selectedSoundIcon');
        const previewName = document.getElementById('selectedSoundName');
        const playBtn = document.getElementById('playSoundBtn');
        
        previewIcon.style.display = 'inline-block';
        previewName.textContent = 'Сонгосон дуу'; // Selected sound
        playBtn.style.display = 'inline-block';
        
    } else if (currentSettings.default_sound_name) {
        // Set selectedSound from default asset
        selectedSound = {
            filename: currentSettings.default_sound_name,
            url: currentSettings.sound_url,
            is_default: true
        };
        
        // Update preview directly from settings
        const previewIcon = document.getElementById('selectedSoundIcon');
        const previewName = document.getElementById('selectedSoundName');
        const playBtn = document.getElementById('playSoundBtn');
        
        previewIcon.style.display = 'inline-block';
        previewName.textContent = currentSettings.default_sound_name;
        playBtn.style.display = 'inline-block';
    }
    
    // Add click handlers for asset selection
    document.querySelectorAll('.asset-item:not(.asset-upload)').forEach(item => {
        item.addEventListener('click', function() {
            selectAsset(this);
        });
    });
}

function selectAsset(element) {
    const gallery = element.closest('.asset-gallery');
    const assetType = gallery.dataset.type;
    
    // Remove previous selection
    gallery.querySelectorAll('.asset-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Add selection to clicked item
    element.classList.add('selected');
    
    // Update selection variables
    if (assetType === 'gif') {
        if (element.dataset.id) {
            selectedGif = {
                id: parseInt(element.dataset.id),
                url: element.dataset.url,
                is_default: false
            };
        } else {
            selectedGif = {
                filename: element.dataset.filename,
                url: element.dataset.url,
                is_default: true
            };
        }
    } else if (assetType === 'sound') {
        if (element.dataset.id) {
            selectedSound = {
                id: parseInt(element.dataset.id),
                url: element.dataset.url,
                is_default: false
            };
        } else {
            selectedSound = {
                filename: element.dataset.filename,
                url: element.dataset.url,
                is_default: true
            };
        }
    }
    
    updatePreview();
}

function updateRangeDisplay(rangeId, displayId, suffix) {
    const range = document.getElementById(rangeId);
    const display = document.getElementById(displayId);
    
    function update() {
        display.textContent = range.value + suffix;
    }
    
    range.addEventListener('input', update);
    update(); // Initial update
}

function updatePreview() {
    // Find the currently active form (either basic tier or active tab)
    let activeForm;
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Advanced tier - find active tab form
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        activeForm = activeTab.querySelector('form');
    }
    {% else %}
    // Basic tier - use the main form
    activeForm = document.getElementById('alertSettingsForm');
    {% endif %}
    
    if (!activeForm) {
        console.error('No active form found for preview');
        return;
    }
    
    const formData = new FormData(activeForm);
    
    // Sample donation data
    const sampleDonation = {
        name: 'Бат-Эрдэнэ',
        amount: 5000,
        message: 'Сайхан stream байна!'
    };
    
    // Get current form values
    const template = formData.get('text_template') || currentSettings.text_template || '{name}-ээс **[{amount}₮]** donation орж ирлээ!';
    const position = formData.get('image_position') || currentSettings.image_position;
    const imageSize = formData.get('image_size') || currentSettings.image_size;
    const transitionType = formData.get('transition_type') || currentSettings.transition_type;
    
    // Get current tab's assets
    const tabAssets = getCurrentTabAssets();
    const currentGif = tabAssets.selectedGif || selectedGif;
    const currentSound = tabAssets.selectedSound || selectedSound;
    
    // Get all styling settings
    const previewSettings = {
        text_template: template,
        image_position: position,
        image_size: parseInt(imageSize) || currentSettings.image_size,
        transition_type: transitionType,
        gif_url: currentGif ? currentGif.url : (currentSettings.gif_url || '/static/assets/default/default.gif'),
        
        // Donator settings
        donator_image_size: parseInt(formData.get('donator_image_size')) || currentSettings.donator_image_size,
        donator_name_size: parseInt(formData.get('donator_name_size')) || currentSettings.donator_name_size,
        donator_name_weight: formData.get('donator_name_weight') || currentSettings.donator_name_weight,
        donator_alignment: formData.get('donator_alignment') || currentSettings.donator_alignment,
        donator_color: formData.get('donator_color') || currentSettings.donator_color,
        
        // Template style settings
        template_size: parseInt(formData.get('template_size')) || currentSettings.template_size,
        template_weight: formData.get('template_weight') || currentSettings.template_weight,
        template_alignment: formData.get('template_alignment') || currentSettings.template_alignment,
        template_accent_color: formData.get('template_accent_color') || currentSettings.template_accent_color,
        template_base_color: formData.get('template_base_color') || currentSettings.template_base_color,
        
        // Message style settings
        message_size: parseInt(formData.get('message_size')) || currentSettings.message_size,
        message_weight: formData.get('message_weight') || currentSettings.message_weight,
        message_alignment: formData.get('message_alignment') || currentSettings.message_alignment,
        message_style: formData.get('message_style') || currentSettings.message_style,
        message_color: formData.get('message_color') || currentSettings.message_color
    };
    
    // Generate preview HTML
    generateAlertPreview(sampleDonation, previewSettings);
}

function generateAlertPreview(donation, settings) {
    // Find the correct preview container (either basic tier or active tab)
    let previewAlert;
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Advanced tier - find active tab preview
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        previewAlert = activeTab.querySelector('#previewAlert, [id^="previewAlert"]');
    }
    {% else %}
    // Basic tier - use the main preview
    previewAlert = document.getElementById('previewAlert');
    {% endif %}
    
    if (!previewAlert) {
        console.error('No preview container found');
        return;
    }
    
    // Process template variables first
    let processedText = settings.text_template
        .replace(/{name}/g, donation.name)
        .replace(/{amount}/g, donation.amount.toLocaleString());
    
    console.log('Template before formatting:', settings.text_template);
    console.log('Template after variable replacement:', processedText);
    
    // Apply text formatting
    processedText = processedText
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **text** -> bold
        .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *text* -> italic
        .replace(/\[(.*?)\]/g, `<span style="color: ${settings.template_accent_color}">$1</span>`); // [text] -> accent color
    
    console.log('Template after formatting:', processedText);
    
    // Create HTML structure with full styling
    const alertHTML = `
        <!-- Donator Profile (if we have donator name) -->
        <div class="donator-profile mb-3" style="
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: ${settings.donator_alignment};
        ">
            <img src="/static/assets/default/avatar.png" alt="Donator" style="
                width: ${settings.donator_image_size}px;
                height: ${settings.donator_image_size}px;
                border-radius: 50%;
                border: 2px solid #6366f1;
                object-fit: cover;
            ">
            <div style="
                font-size: ${settings.donator_name_size}px;
                font-weight: ${settings.donator_name_weight};
                color: ${settings.donator_color};
            ">${donation.name}</div>
        </div>

        <!-- Main Alert Content -->
        <div class="d-flex align-items-center gap-3" style="
            flex-direction: ${settings.image_position === 'top' ? 'column' : 
                           settings.image_position === 'bottom' ? 'column-reverse' : 'row'};
            text-align: ${settings.template_alignment};
        ">
            ${settings.image_position === 'right' ? 
                `<div class="alert-content" style="
                    color: ${settings.template_base_color};
                    font-size: ${settings.template_size}px;
                    font-weight: ${settings.template_weight};
                    text-align: ${settings.template_alignment};
                ">${processedText}</div>` : ''}
            
            <div class="alert-image">
                <img src="${settings.gif_url}" alt="Donation GIF" style="
                    width: ${Math.round(120 * settings.image_size / 100)}px;
                    height: ${Math.round(120 * settings.image_size / 100)}px;
                    object-fit: cover;
                    border-radius: 8px;
                ">
            </div>
            
            ${settings.image_position !== 'right' ? 
                `<div class="alert-content" style="
                    color: ${settings.template_base_color};
                    font-size: ${settings.template_size}px;
                    font-weight: ${settings.template_weight};
                    text-align: ${settings.template_alignment};
                ">${processedText}</div>` : ''}
        </div>
        
        ${donation.message ? `<div class="alert-message mt-3" style="
            color: ${settings.message_color};
            font-size: ${settings.message_size}px;
            font-weight: ${settings.message_weight};
            text-align: ${settings.message_alignment};
            font-style: ${settings.message_style};
            opacity: 0.9;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        ">"${donation.message}"</div>` : ''}
    `;
    
    previewAlert.innerHTML = alertHTML;
    previewAlert.className = 'donation-alert';
    previewAlert.style.display = 'block';
    previewAlert.style.opacity = '1';
}

// Global variable for testing alerts
let alertPreviewActive = false;

function testAlert() {
    if (alertPreviewActive) {
        console.log('Alert preview already running, skipping...');
        return;
    }
    
    alertPreviewActive = true;
    
    // Sample test data
    const testDonation = {
        name: 'Тест хэрэглэгч',
        amount: 25000,
        message: 'Энэ бол туршилтын донейт мессеж! 🎉'
    };
    
    // Update preview with test data first
    updatePreview();
    
    // Find the active preview element
    let previewAlert;
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        previewAlert = activeTab.querySelector('#previewAlert, [id^="previewAlert"]');
    }
    {% else %}
    previewAlert = document.getElementById('previewAlert');
    {% endif %}
    
    if (!previewAlert) {
        alertPreviewActive = false;
        return;
    }
    
    // Animate the test alert
    previewAlert.style.transform = 'scale(0.8)';
    previewAlert.style.opacity = '0';
    
    setTimeout(() => {
        previewAlert.style.transition = 'all 0.5s ease';
        previewAlert.style.transform = 'scale(1)';
        previewAlert.style.opacity = '1';
        
        setTimeout(() => {
            previewAlert.style.opacity = '0.8';
            alertPreviewActive = false;
        }, 3000);
    }, 100);
}

// Asset modal management
let currentModalType = 'gif';
let selectedModalAsset = null;

function openAssetModal(type) {
    currentModalType = type;
    selectedModalAsset = null;
    
    const modal = new bootstrap.Modal(document.getElementById('assetModal'));
    const modalTitle = document.getElementById('assetModalLabel');
    const confirmBtn = document.getElementById('confirmSelectBtn');
    
    modalTitle.textContent = type === 'gif' ? 'Зураг сонгох' : 'Дуу сонгох';
    confirmBtn.disabled = true;
    
    // Update allowed file types display
    const allowedTypes = type === 'gif' ? 'GIF, PNG, JPEG' : 'MP3, WAV, OGG';
    const maxSize = type === 'gif' ? '10MB' : '5MB';
    
    document.getElementById('allowedTypes').textContent = allowedTypes;
    document.getElementById('maxSize').textContent = maxSize;
    
    // Update asset counts immediately
    const userAssets = currentModalType === 'gif' ? window.userGifs : window.userSounds;
    const defaultAssets = currentModalType === 'gif' ? window.defaultGifs : window.defaultSounds;
    
    console.log(`Asset counts for ${currentModalType}: User=${userAssets.length}, Default=${defaultAssets.length}`);
    
    document.getElementById('userAssetCount').textContent = userAssets.length;
    document.getElementById('defaultAssetCount').textContent = defaultAssets.length;
    
    // Load assets and activate user tab
    switchAssetTab('user');
    
    modal.show();
}

function switchAssetTab(tabType) {
    const userTab = document.getElementById('userAssetsTab');
    const defaultTab = document.getElementById('defaultAssetsTab');
    const gallery = document.getElementById('modalAssetGallery');
    
    // Update tab styles
    if (tabType === 'user') {
        userTab.classList.add('btn-primary');
        userTab.classList.remove('btn-outline-primary');
        defaultTab.classList.add('btn-outline-primary');
        defaultTab.classList.remove('btn-primary');
    } else {
        defaultTab.classList.add('btn-primary');
        defaultTab.classList.remove('btn-outline-primary');
        userTab.classList.add('btn-outline-primary');
        userTab.classList.remove('btn-primary');
    }
    
    // Load assets
    if (tabType === 'user') {
        loadUserAssets();
    } else {
        loadDefaultAssets();
    }
}

function loadUserAssets() {
    const gallery = document.getElementById('modalAssetGallery');
    const assets = currentModalType === 'gif' ? window.userGifs : window.userSounds;
    const countSpan = document.getElementById('userAssetCount');
    
    countSpan.textContent = assets.length;
    
    // Clear gallery and ensure it has the grid class
    gallery.innerHTML = '';
    gallery.className = 'asset-modal-gallery';
    
    // Force grid layout with inline styles to override any conflicting CSS
    gallery.style.display = 'grid';
    gallery.style.gridTemplateColumns = 'repeat(auto-fill, minmax(120px, 1fr))';
    gallery.style.gap = '10px';
    gallery.style.padding = '10px';
    
    console.log('Gallery element:', gallery, 'Classes:', gallery.className, 'Style:', gallery.style.display);
    
    assets.forEach(asset => {
        const assetDiv = document.createElement('div');
        assetDiv.className = 'asset-item';
        assetDiv.dataset.id = asset.id;
        assetDiv.dataset.url = asset.url;
        assetDiv.onclick = () => selectModalAsset(assetDiv, false);
        
        if (currentModalType === 'gif') {
            assetDiv.innerHTML = `
                <img src="${asset.url}" alt="${asset.filename}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                <div class="asset-name mt-1">${asset.filename}</div>
                <button class="btn btn-sm btn-danger" onclick="deleteModalAsset(event, ${asset.id})" style="position: absolute; top: 5px; right: 5px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else {
            assetDiv.innerHTML = `
                <i class="fas fa-music fa-3x mb-2" style="color: #6366f1;"></i>
                <div class="asset-name">${asset.filename}</div>
                <button class="btn btn-sm btn-secondary" onclick="playModalSound(event, '${asset.url}')" style="margin: 5px;">
                    <i class="fas fa-play"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteModalAsset(event, ${asset.id})" style="position: absolute; top: 5px; right: 5px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
        }
        
        gallery.appendChild(assetDiv);
    });
}

function loadDefaultAssets() {
    const gallery = document.getElementById('modalAssetGallery');
    const assets = currentModalType === 'gif' ? window.defaultGifs : window.defaultSounds;
    const countSpan = document.getElementById('defaultAssetCount');
    
    countSpan.textContent = assets.length;
    
    // Clear gallery and ensure it has the grid class
    gallery.innerHTML = '';
    gallery.className = 'asset-modal-gallery';
    
    // Force grid layout with inline styles to override any conflicting CSS
    gallery.style.display = 'grid';
    gallery.style.gridTemplateColumns = 'repeat(auto-fill, minmax(120px, 1fr))';
    gallery.style.gap = '10px';
    gallery.style.padding = '10px';
    
    console.log('Gallery element:', gallery, 'Classes:', gallery.className, 'Style:', gallery.style.display);
    
    assets.forEach(asset => {
        const assetDiv = document.createElement('div');
        assetDiv.className = 'asset-item';
        assetDiv.dataset.filename = asset.filename;
        assetDiv.dataset.url = asset.url;
        assetDiv.onclick = () => selectModalAsset(assetDiv, true);
        
        if (currentModalType === 'gif') {
            assetDiv.innerHTML = `
                <img src="${asset.url}" alt="${asset.filename}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                <div class="asset-name mt-1">${asset.filename}</div>
            `;
        } else {
            assetDiv.innerHTML = `
                <i class="fas fa-music fa-3x mb-2" style="color: #6366f1;"></i>
                <div class="asset-name">${asset.filename}</div>
                <button class="btn btn-sm btn-secondary" onclick="playModalSound(event, '${asset.url}')" style="margin: 5px;">
                    <i class="fas fa-play"></i>
                </button>
            `;
        }
        
        gallery.appendChild(assetDiv);
    });
}

function selectModalAsset(element, isDefault) {
    // Remove previous selection
    document.querySelectorAll('#modalAssetGallery .asset-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Add selection to clicked item
    element.classList.add('selected');
    
    // Store selection
    if (isDefault) {
        selectedModalAsset = {
            filename: element.dataset.filename,
            url: element.dataset.url,
            is_default: true
        };
    } else {
        selectedModalAsset = {
            id: parseInt(element.dataset.id),
            url: element.dataset.url,
            is_default: false
        };
    }
    
    // Enable confirm button
    document.getElementById('confirmSelectBtn').disabled = false;
}

function confirmAssetSelection() {
    if (!selectedModalAsset) return;
    
    if (currentModalType === 'gif') {
        // Set asset for current tab
        setCurrentTabAssets(selectedModalAsset, undefined);
        
        // Update preview in the current tab's form
        let previewImg, previewName;
        
        {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
        const activeTab = document.querySelector('.tab-pane.active');
        if (activeTab) {
            previewImg = activeTab.querySelector('#selectedGifImage, [id^="selectedGifImage"]');
            previewName = activeTab.querySelector('#selectedGifName, [id^="selectedGifName"]');
        }
        {% else %}
        previewImg = document.getElementById('selectedGifImage');
        previewName = document.getElementById('selectedGifName');
        {% endif %}
        
        if (previewImg && previewName) {
            previewImg.src = selectedModalAsset.url;
            previewImg.style.display = 'block';
            previewName.textContent = selectedModalAsset.filename || 'Сонгосон зураг';
        }
    } else {
        // Set asset for current tab
        setCurrentTabAssets(undefined, selectedModalAsset);
        
        // Update preview in the current tab's form
        let previewIcon, previewName, playBtn;
        
        {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
        const activeTab = document.querySelector('.tab-pane.active');
        if (activeTab) {
            previewIcon = activeTab.querySelector('#selectedSoundIcon, [id^="selectedSoundIcon"]');
            previewName = activeTab.querySelector('#selectedSoundName, [id^="selectedSoundName"]');
            playBtn = activeTab.querySelector('#playSoundBtn, [id^="playSoundBtn"]');
        }
        {% else %}
        previewIcon = document.getElementById('selectedSoundIcon');
        previewName = document.getElementById('selectedSoundName');
        playBtn = document.getElementById('playSoundBtn');
        {% endif %}
        
        if (previewIcon && previewName && playBtn) {
            previewIcon.style.display = 'inline-block';
            previewName.textContent = selectedModalAsset.filename || 'Сонгосон дуу';
            playBtn.style.display = 'inline-block';
        }
    }
    
    // Update preview
    updatePreview();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('assetModal'));
    modal.hide();
}

function triggerFileUpload() {
    document.getElementById('modalFileUpload').click();
}

function uploadAssetFromModal(file) {
    if (!file) return;
    
    // Validate file
    const maxSize = currentModalType === 'gif' ? 10 * 1024 * 1024 : 5 * 1024 * 1024;
    if (file.size > maxSize) {
        alert(`Файлын хэмжээ хэтэрсэн байна. Хамгийн ихдээ ${maxSize / 1024 / 1024}MB байх ёстой.`);
        return;
    }
    
    const allowedTypes = currentModalType === 'gif' ? 
        ['image/gif', 'image/png', 'image/jpeg'] : 
        ['audio/mpeg', 'audio/wav', 'audio/ogg'];
    
    if (!allowedTypes.includes(file.type)) {
        alert('Зөвшөөрөгдөөгүй файлын төрөл байна.');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('asset_type', currentModalType);
    
    fetch('/donation-alert/upload-asset', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add to user assets
            if (currentModalType === 'gif') {
                window.userGifs = window.userGifs || [];
                window.userGifs.push(data.asset);
            } else {
                window.userSounds = window.userSounds || [];
                window.userSounds.push(data.asset);
            }
            
            // Reload user assets tab
            switchAssetTab('user');
            alert('Файл амжилттай нэмэгдлээ!');
        } else {
            alert('Алдаа: ' + data.error);
        }
    })
    .catch(error => {
        alert('Файл байршуулахад алдаа гарлаа.');
    });
}

function deleteModalAsset(event, assetId) {
    event.stopPropagation();
    
    if (!confirm('Та энэ файлыг устгахыг хүсэж байна уу?')) {
        return;
    }
    
    fetch(`/donation-alert/delete-asset/${assetId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove from local arrays
            if (currentModalType === 'gif') {
                window.userGifs = window.userGifs.filter(asset => asset.id !== assetId);
            } else {
                window.userSounds = window.userSounds.filter(asset => asset.id !== assetId);
            }
            
            // Reload user assets
            loadUserAssets();
            alert('Файл амжилттай устгагдлаа!');
        } else {
            alert('Алдаа: ' + data.error);
        }
    })
    .catch(error => {
        alert('Файл устгахад алдаа гарлаа.');
    });
}

// Global variable to track currently playing modal audio
let currentModalAudio = null;

function playModalSound(event, url) {
    event.stopPropagation();
    
    // Get the volume from the active form's volume slider
    let volumeSlider;
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Advanced tier - find active tab's volume slider
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        volumeSlider = activeTab.querySelector('#soundVolume, [id^="soundVolume"]');
    }
    {% else %}
    // Basic tier - use the main volume slider
    volumeSlider = document.getElementById('soundVolume');
    {% endif %}
    
    const volume = volumeSlider ? volumeSlider.value : 50;
    console.log('Modal sound volume:', volume, 'from slider:', volumeSlider);
    
    // Stop any currently playing modal audio
    if (currentModalAudio) {
        currentModalAudio.pause();
        currentModalAudio.currentTime = 0;
        currentModalAudio = null;
    }
    
    // Create and play new audio with correct volume
    currentModalAudio = new Audio(url);
    currentModalAudio.volume = volume / 100;
    
    // Clear reference when audio ends
    currentModalAudio.addEventListener('ended', () => {
        currentModalAudio = null;
    });
    
    currentModalAudio.play().catch(error => {
        console.error('Error playing modal sound:', error);
        currentModalAudio = null;
    });
}

function playSelectedSound() {
    const tabAssets = getCurrentTabAssets();
    const currentSound = tabAssets.selectedSound || selectedSound;
    
    if (currentSound && currentSound.url) {
        // Get the volume from the active form's volume slider
        let volumeSlider;
        
        {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
        // Advanced tier - find active tab's volume slider
        const activeTab = document.querySelector('.tab-pane.active');
        if (activeTab) {
            volumeSlider = activeTab.querySelector('#soundVolume, [id^="soundVolume"]');
        }
        {% else %}
        // Basic tier - use the main volume slider
        volumeSlider = document.getElementById('soundVolume');
        {% endif %}
        
        const volume = volumeSlider ? volumeSlider.value : 50;
        console.log('Selected sound volume:', volume, 'from slider:', volumeSlider);
        
        // Stop any currently playing audio
        if (currentModalAudio) {
            currentModalAudio.pause();
            currentModalAudio.currentTime = 0;
            currentModalAudio = null;
        }
        
        // Create and play new audio with correct volume
        currentModalAudio = new Audio(currentSound.url);
        currentModalAudio.volume = volume / 100;
        
        // Clear reference when audio ends
        currentModalAudio.addEventListener('ended', () => {
            currentModalAudio = null;
        });
        
        currentModalAudio.play().catch(error => {
            console.error('Error playing sound:', error);
            currentModalAudio = null;
        });
    }
}

function copyOverlayUrl(event) {
    // Generate the overlay URL using the current user's token
    const overlayToken = '{{ overlay_token }}';
    const baseUrl = window.location.origin;
    const url = `${baseUrl}/overlay/${overlayToken}`;
    
    navigator.clipboard.writeText(url).then(() => {
        // Show temporary success message
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Хуулагдлаа!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-primary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    });
}

// Global variable to track currently playing voice sample
let currentVoiceSample = null;
let currentVoiceButton = null;

// Voice Sample Playback Function
function playVoiceSample(voiceId) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    // Stop any currently playing voice sample
    if (currentVoiceSample) {
        currentVoiceSample.pause();
        currentVoiceSample.currentTime = 0;
        
        // Reset the previous button
        if (currentVoiceButton) {
            const prevBtn = currentVoiceButton;
            const prevText = prevBtn.getAttribute('data-original-text') || prevBtn.textContent;
            prevBtn.innerHTML = prevText;
            prevBtn.disabled = false;
        }
    }
    
    // Store original text for this button
    btn.setAttribute('data-original-text', originalText);
    
    // Disable button and show loading state
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Тоглож байна...';
    btn.disabled = true;
    
    // Get user's volume setting
    const volumeInput = document.getElementById('soundVolume');
    const volume = volumeInput ? volumeInput.value : 50;
    
    // Play the pre-recorded voice sample
    const audioUrl = `/static/assets/voice_models/${voiceId}_sample.wav`;
    const audio = new Audio(audioUrl);
    audio.volume = volume / 100;
    
    // Set as current playing sample
    currentVoiceSample = audio;
    currentVoiceButton = btn;
    
    audio.onloadeddata = () => {
        audio.play();
    };
    
    audio.onended = () => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        currentVoiceSample = null;
        currentVoiceButton = null;
    };
    
    audio.onerror = () => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        currentVoiceSample = null;
        currentVoiceButton = null;
        alert('Дуулгалт ачаалах боломжгүй байна');
    };
    
    // Auto-stop after 10 seconds as fallback
    setTimeout(() => {
        if (currentVoiceSample === audio && !audio.ended) {
            audio.pause();
            audio.currentTime = 0;
            btn.innerHTML = originalText;
            btn.disabled = false;
            currentVoiceSample = null;
            currentVoiceButton = null;
        }
    }, 10000);
}

// TTS Usage Display Function
function loadTTSUsage() {
    const displayDiv = document.getElementById('ttsUsageDisplay');
    
    if (displayDiv.style.display === 'none') {
        // Load usage data
        fetch('/api/tts/usage')
        .then(response => response.json())
        .then(data => {
            // Update display with separate elements
            document.getElementById('dailyUsage').textContent = data.daily.requests;
            document.getElementById('dailyLimit').textContent = data.daily.limit_requests;
            document.getElementById('dailyChars').textContent = data.daily.characters;
            document.getElementById('dailyCharLimit').textContent = data.daily.limit_characters;
            
            document.getElementById('monthlyUsage').textContent = data.monthly.requests;
            document.getElementById('monthlyLimit').textContent = data.monthly.limit_requests;
            document.getElementById('monthlyChars').textContent = data.monthly.characters;
            document.getElementById('monthlyCharLimit').textContent = data.monthly.limit_characters;
            
            displayDiv.style.display = 'block';
        })
        .catch(error => {
            alert('Хэрэглээний мэдээлэл ачаалж чадсангүй');
        });
    } else {
        displayDiv.style.display = 'none';
    }
}

// Form event listeners and submission handling
document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners for both basic and advanced tier forms
    function setupFormEventListeners() {
        // Find all forms (basic tier or tabs)
        const forms = document.querySelectorAll('form[id^="alertSettingsForm"]');
        
        forms.forEach(form => {
            // Add input and change listeners for real-time preview
            form.addEventListener('input', updatePreview);
            form.addEventListener('change', updatePreview);
            
            // Add form submission listener
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                
                // Handle checkboxes explicitly (FormData doesn't include unchecked checkboxes)
                const ttsEnabledCheckbox = this.querySelector('#ttsEnabled, [id^="ttsEnabled"]');
                if (ttsEnabledCheckbox) {
                    data.tts_enabled = ttsEnabledCheckbox.checked;
                }
                
                // Convert seconds to milliseconds for backend
                if (data.visible_time) {
                    data.visible_time = Math.round(parseFloat(data.visible_time) * 1000);
                }
                if (data.animation_speed) {
                    data.animation_speed = Math.round(parseFloat(data.animation_speed) * 1000);
                }
                
                // Get current tab assets (either global or per-tab)
                const currentAssets = getCurrentTabAssets();
                
                if (currentAssets.selectedGif) {
                    if (currentAssets.selectedGif.is_default) {
                        data.default_gif_name = currentAssets.selectedGif.filename;
                        data.selected_gif_id = null;
                    } else {
                        data.selected_gif_id = currentAssets.selectedGif.id;
                        data.default_gif_name = null;
                    }
                }
                
                if (currentAssets.selectedSound) {
                    if (currentAssets.selectedSound.is_default) {
                        data.default_sound_name = currentAssets.selectedSound.filename;
                        data.selected_sound_id = null;
                    } else {
                        data.selected_sound_id = currentAssets.selectedSound.id;
                        data.default_sound_name = null;
                    }
                }
                
                // Determine API endpoint based on tier and tab
                {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
                const tabNumber = getCurrentActiveTabNumber();
                const endpoint = `/donation-alert/configurations/${tabNumber}`;
                {% else %}
                const endpoint = '/donation-alert/settings';
                {% endif %}
                
                // Submit settings
                fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(responseData => {
                    if (responseData.success) {
                        // Update tab label with new minimum amount for advanced tier
                        {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
                        const tabNumber = getCurrentActiveTabNumber();
                        const minimumAmount = parseFloat(data.minimum_amount) || 0;
                        updateTabLabel(tabNumber, minimumAmount);
                        {% endif %}
                        
                        // Show success message
                        const btn = this.querySelector('button[type="submit"]');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-check me-2"></i>Хадгалагдлаа!';
                        btn.classList.add('btn-success');
                        btn.classList.remove('btn-primary');
                        
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-primary');
                        }, 2000);
                    } else {
                        alert('Алдаа гарлаа: ' + (responseData.error || 'Тодорхойгүй алдаа'));
                    }
                })
                .catch(error => {
                    alert('Холболтын алдаа гарлаа');
                });
            });
        });
    }
    
    // Initial setup
    setupFormEventListeners();
    
    // Re-setup when new tabs are added
    const originalAddNewAlertTab = window.addNewAlertTab;
    window.addNewAlertTab = function() {
        originalAddNewAlertTab.call(this);
        // Add event listeners to the new tab's form
        setTimeout(() => {
            setupFormEventListeners();
            {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
            setupMinimumAmountListeners();
            {% endif %}
        }, 100);
    };
    
    // Add drag and drop functionality to upload area
    const uploadArea = document.getElementById('uploadArea');
    
    if (uploadArea) {
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadAssetFromModal(files[0]);
            }
        });
    }
    
    // Initial preview update after everything is loaded
    setTimeout(() => {
        updatePreview();
    }, 500);
});

// Add Socket.IO for real-time alert testing if available
if (typeof io !== 'undefined') {
    const userId = {{ current_user.id if current_user.is_authenticated else 'null' }};
    
    const socket = io();
    
    socket.on('connect', function() {
        console.log('Settings page socket connected');
    });
    
    socket.on('disconnect', function() {
        console.log('Settings page socket disconnected');
    });
}
</script>

{% endblock %}