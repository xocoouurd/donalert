{% extends "base.html" %}
{% block title %}Донейт алерт - DonAlert{% endblock %}
{% block body_class %}dashboard-page{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/donation-alert.css') }}">
<script src="https://cdn.socket.io/4.6.2/socket.io.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    {% include 'components/sidebar.html' %}

    <div class="dashboard-content">
        <div class="glass-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Донейт алерт тохиргоо</h2>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="testAlert()">
                        <i class="fas fa-play me-1"></i>Туршилт
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="copyOverlayUrl(event)">
                        <i class="fas fa-copy me-1"></i>Overlay URL
                    </button>
                </div>
            </div>

            <!-- Alert Tabs (Advanced Tier Only) -->
            {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
            <div class="alert-tabs-container mb-4">
                <ul class="nav nav-tabs alert-tabs" id="alertTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="alert-1-tab" data-bs-toggle="tab" data-bs-target="#alert-1" 
                                type="button" role="tab" aria-controls="alert-1" aria-selected="true">
                            <i class="fas fa-bell me-1"></i>Алерт 1 (₮0+)
                        </button>
                    </li>
                    <li class="nav-item add-tab-item" role="presentation">
                        <button class="nav-link add-tab-btn" type="button" onclick="addNewAlertTab()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </li>
                </ul>
            </div>

            <!-- Advanced Tier - Tabbed Content -->
            <div class="tab-content" id="alertTabContent">
                <!-- Tab 1 (Default Alert) -->
                <div class="tab-pane fade show active" id="alert-1" role="tabpanel" aria-labelledby="alert-1-tab">
                    <div class="row">
                        <!-- Settings Panel -->
                        <div class="col-xl-7 col-lg-7">
                            <form id="alertSettingsForm" onsubmit="return false;">
                                {% include 'components/alert_settings_form.html' %}
                                
                                <!-- Save Button -->
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Тохиргоо хадгалах
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Live Preview Panel -->
                        <div class="col-xl-5 col-lg-5">
                            <div class="glass-card p-3 sticky-top">
                                <h5 class="mb-3"><i class="fas fa-eye me-2"></i>Урьдчилан үзэх</h5>
                                
                                <div id="alertPreview" class="alert-preview-container">
                                    <div class="preview-background">
                                        <div id="previewAlert" class="donation-alert" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
                                            <!-- Preview content will be generated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Browser Audio Policy Warning -->
                                <div class="alert alert-warning mt-3 py-2" style="font-size: 0.85rem;">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Анхааруулга:</strong> Google Chrome зэрэг зарим хөтөч нь хуудастай эхлээд харилцах хэрэгтэй байдаг тул дуу автоматаар тоглохгүй байж болно. Энэ асуудал OBS дээр тохиолдохгүй.
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Basic Tier - Imitation Tabs -->
            {% if not (current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced') %}
            <div class="alert-tabs-container mb-4">
                <ul class="nav nav-tabs alert-tabs">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" type="button" disabled id="basicTierTab">
                            <i class="fas fa-bell me-1"></i>Алерт 1 (<span id="basicTabAmount">₮0</span>+)
                        </button>
                    </li>
                    <li class="nav-item add-tab-item" role="presentation">
                        <button class="nav-link add-tab-btn" type="button" 
                                data-bs-toggle="tooltip" 
                                data-bs-placement="top" 
                                data-bs-title="Дэвшилтэт хэрэглэгч болон түүнээс дээш түвшинтэй байх хэрэгтэй. Олон төрлийн алерт хэрэглэхийн тулд дэвшилтэт буюу премиум багцаас сонгон авна уу."
                                id="basicTierAddBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </li>
                </ul>
            </div>
            
            <div class="row">
                <!-- Settings Panel -->
                <div class="col-xl-7 col-lg-7">
                    <form id="alertSettingsForm" onsubmit="return false;">
                        {% include 'components/alert_settings_form.html' %}
                        
                        <!-- Save Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Тохиргоо хадгалах
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Live Preview Panel -->
                <div class="col-xl-5 col-lg-5">
                    <div class="glass-card p-3 sticky-top">
                        <h5 class="mb-3"><i class="fas fa-eye me-2"></i>Урьдчилан үзэх</h5>
                        
                        <div id="alertPreview" class="alert-preview-container">
                            <div class="preview-background">
                                <div id="previewAlert" class="donation-alert" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
                                    <!-- Preview content will be generated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Browser Audio Policy Warning -->
                        <div class="alert alert-warning mt-3 py-2" style="font-size: 0.85rem;">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Анхааруулга:</strong> Google Chrome зэрэг зарим хөтөч нь хуудастай эхлээд харилцах хэрэгтэй байдаг тул дуу автоматаар тоглохгүй байж болно. Энэ асуудал OBS дээр тохиолдохгүй.
                        </div>

                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Asset Selection Modal -->
<div class="modal fade" id="assetModal" tabindex="-1" aria-labelledby="assetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px;">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="assetModalLabel">Зураг сонгох</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Upload Section -->
                    <div class="col-12 mb-4">
                        <div class="glass-card p-3">
                            <h6 class="mb-3"><i class="fas fa-upload me-2"></i>Шинэ файл нэмэх</h6>
                            <div class="upload-area" onclick="triggerFileUpload()" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                                <p class="mb-2"><strong>Файл сонгох эсвэл энд чирж оруулах</strong></p>
                                <p class="text-muted small">Зөвшөөрөгдсөн файл: <span id="allowedTypes"></span></p>
                                <p class="text-muted small">Хамгийн их хэмжээ: <span id="maxSize"></span></p>
                            </div>
                            <input type="file" id="modalFileUpload" style="display: none;" onchange="uploadAssetFromModal(this.files[0])">
                        </div>
                    </div>
                    
                    <!-- Asset Gallery -->
                    <div class="col-12">
                        <div class="row" id="assetTabs">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100 mb-3" id="userAssetsTab" onclick="switchAssetTab('user')" style="height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user me-2"></i>Миний файлууд (<span id="userAssetCount">0</span>)
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100 mb-3" id="defaultAssetsTab" onclick="switchAssetTab('default')" style="height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-star me-2"></i>Үндсэн файлууд (<span id="defaultAssetCount">0</span>)
                                </button>
                            </div>
                        </div>
                        
                        <div class="asset-modal-gallery" id="modalAssetGallery">
                            <!-- Assets will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Цуцлах</button>
                <button type="button" class="btn btn-primary" onclick="confirmAssetSelection()" id="confirmSelectBtn" disabled>Сонгох</button>
            </div>
        </div>
    </div>
</div>


<script>
// Current settings
let currentSettings = {{ settings.to_dict() | tojson }};

// Per-tab asset selections - stores selections for each tab
let tabAssetSelections = {
    1: { // Default tab
        selectedGif: null,
        selectedSound: null
    }
};

// Global fallback for basic tier
let selectedGif = null;
let selectedSound = null;

// Form State Manager - preserves unsaved changes when switching tabs
const formStateManager = {
    states: {}, // Store form data for each tab
    
    // Save current form state for a tab
    saveTabState: function(tabNumber) {
        const tabPane = document.getElementById(`alert-${tabNumber}`);
        if (!tabPane) return;
        
        const form = tabPane.querySelector('form');
        if (!form) return;
        
        // Collect all form data
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Handle checkboxes explicitly (they won't appear in FormData if unchecked)
        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            data[checkbox.name] = checkbox.checked;
        });
        
        // Handle select elements explicitly to ensure correct values
        const ttsSpeedSelect = form.querySelector('[name="tts_speed"]');
        const ttsPitchSelect = form.querySelector('[name="tts_pitch"]');
        const ttsVoiceSelect = form.querySelector('[name="tts_voice"]');
        
        if (ttsSpeedSelect) {
            data.tts_speed = ttsSpeedSelect.value;
        }
        if (ttsPitchSelect) {
            data.tts_pitch = ttsPitchSelect.value;
        }
        if (ttsVoiceSelect) {
            data.tts_voice = ttsVoiceSelect.value;
        }
        
        // Store the state
        this.states[tabNumber] = data;
    },
    
    // Restore form state for a tab
    restoreTabState: function(tabNumber) {
        const savedState = this.states[tabNumber];
        if (!savedState) return false; // No saved state
        
        const tabPane = document.getElementById(`alert-${tabNumber}`);
        if (!tabPane) return false;
        
        const form = tabPane.querySelector('form');
        if (!form) return false;
        
        
        // Restore all form fields
        Object.keys(savedState).forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (field) {
                if (field.type === 'checkbox') {
                    field.checked = savedState[fieldName];
                } else {
                    field.value = savedState[fieldName];
                }
                
                // Trigger change event to update any connected displays (like range sliders)
                field.dispatchEvent(new Event('input', { bubbles: true }));
                field.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
        
        return true; // State was restored
    },
    
    // Clear saved state for a tab (call when form is successfully saved)
    clearTabState: function(tabNumber) {
        delete this.states[tabNumber];
    },
    
    // Check if tab has unsaved changes
    hasUnsavedChanges: function(tabNumber) {
        return this.states.hasOwnProperty(tabNumber);
    }
};

// Alert tabs management
let alertTabCounter = 1;
let maxAlertTabs = 5; // Maximum number of alert tabs allowed
let currentActiveTab = 1; // Track which tab is currently active

// Asset data for modal
window.userGifs = {{ user_gifs | tojson }};
window.userSounds = {{ user_sounds | tojson }};
window.defaultGifs = {{ default_gifs | tojson }};
window.defaultSounds = {{ default_sounds | tojson }};

// alertTabCounter will be initialized from backend data when needed

// Helper function to format amount for tab labels
function formatAmount(amount) {
    return amount > 0 ? `₮${amount.toLocaleString()}+` : '₮0+';
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize asset selections
    initializeAssetSelections();
    
    // Initialize range displays
    updateRangeDisplay('imageSize', 'imageSizeDisplay', '%');
    updateRangeDisplay('soundVolume', 'soundVolumeDisplay', '%');
    
    // Note: Event listeners are now handled by setupFormEventListeners() to prevent duplicates
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Add real-time minimum amount updates for tab labels with duplicate validation
    function setupMinimumAmountListeners() {
        const forms = document.querySelectorAll('form[id^="alertSettingsForm"]');
        forms.forEach(form => {
            const minimumAmountInput = form.querySelector('[name="minimum_amount"]');
            if (minimumAmountInput) {
                minimumAmountInput.addEventListener('input', function() {
                    // Get tab number from input's parent tab pane (more reliable than UI state)
                    const tabPane = this.closest('.tab-pane');
                    const tabNumber = tabPane ? parseInt(tabPane.id.replace('alert-', '')) : getCurrentActiveTabNumber();
                    const value = parseFloat(this.value) || 0;
                    
                    // Check for duplicate amounts and validate
                    validateMinimumAmount(tabNumber, value, this);
                    
                    // Update tab label
                    updateTabLabel(tabNumber, value);
                });
            }
        });
    }
    
    // Validate minimum amount for duplicates and provide suggestions
    function validateMinimumAmount(currentTabNumber, amount, inputElement) {
        // Get all other tab amounts
        const otherAmounts = [];
        const allTabs = document.querySelectorAll('[id^="alert-"][id$="-tab"]');
        
        allTabs.forEach(tab => {
            const tabId = tab.id.replace('-tab', '');
            const tabNumber = parseInt(tabId.replace('alert-', ''));
            
            if (tabNumber !== currentTabNumber) {
                const tabPane = document.getElementById(tabId);
                if (tabPane) {
                    const amountInput = tabPane.querySelector('[name="minimum_amount"]');
                    if (amountInput && amountInput.value) {
                        const tabAmount = parseFloat(amountInput.value) || 0;
                        otherAmounts.push({ tab: tabNumber, amount: tabAmount });
                    }
                }
            }
        });
        
        // Check for duplicates
        const isDuplicate = otherAmounts.some(other => other.amount === amount);
        
        // Get or create validation message element
        let validationMsg = inputElement.parentNode.querySelector('.amount-validation');
        if (!validationMsg) {
            validationMsg = document.createElement('div');
            validationMsg.className = 'amount-validation mt-1';
            inputElement.parentNode.appendChild(validationMsg);
        }
        
        if (isDuplicate) {
            const duplicateTab = otherAmounts.find(other => other.amount === amount);
            const suggestedAmount = findNextAvailableAmount(amount, otherAmounts);
            
            validationMsg.innerHTML = `
                <small class="text-warning">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    ₮${amount.toLocaleString()} дүнг Алерт ${duplicateTab.tab}-д ашигласан байна. 
                    Санал болгох: ₮${suggestedAmount.toLocaleString()}
                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="applySuggestedAmount(${currentTabNumber}, ${suggestedAmount})">
                        Ашиглах
                    </button>
                </small>
            `;
            inputElement.classList.add('border-warning');
        } else {
            validationMsg.innerHTML = '';
            inputElement.classList.remove('border-warning');
        }
    }
    
    // Find the next available amount suggestion
    function findNextAvailableAmount(baseAmount, existingAmounts) {
        const usedAmounts = existingAmounts.map(a => a.amount).sort((a, b) => a - b);
        
        // If baseAmount is 0, suggest increments of 500
        if (baseAmount === 0) {
            let suggestion = 500;
            while (usedAmounts.includes(suggestion)) {
                suggestion += 500;
            }
            return suggestion;
        }
        
        // For other amounts, try increments
        let suggestion = baseAmount;
        const increment = baseAmount >= 1000 ? 500 : 100;
        
        do {
            suggestion += increment;
        } while (usedAmounts.includes(suggestion));
        
        return suggestion;
    }
    
    // Apply suggested amount
    function applySuggestedAmount(tabNumber, amount) {
        const tabPane = document.getElementById(`alert-${tabNumber}`);
        if (tabPane) {
            const amountInput = tabPane.querySelector('[name="minimum_amount"]');
            if (amountInput) {
                amountInput.value = amount;
                amountInput.dispatchEvent(new Event('input'));
            }
        }
    }
    
    // Initial setup for existing forms
    setupMinimumAmountListeners();
    {% endif %}
    
    // Initial preview
    updatePreview();
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Initialize tab 1 with current settings
    if (currentSettings) {
        // Update tab label
        if (currentSettings.minimum_amount !== undefined) {
            updateTabLabel(1, currentSettings.minimum_amount);
        }
        
        // Load tab 1 assets from initial settings - ensure to pass the complete config
        populateTabForm(1, currentSettings);
    }
    
    // Initialize configurations from backend data
    {% if alert_configurations %}
    const configs = {{ alert_configurations | tojson }};
    
    // Create tabs and load configurations for all saved tabs
    configs.forEach(config => {
        if (config.tab_number === 1) {
            // Tab 1 already exists, just populate it
            populateTabForm(1, config);
            
            // Mark tab 1 as saved since it has database configuration
            const tab1Pane = document.getElementById('alert-1');
            if (tab1Pane) {
                tab1Pane.dataset.saved = 'true';
            }
        } else {
            // Create tabs 2, 3, 4, etc. from saved configurations
            createTabFromConfig(config);
        }
    });
    {% endif %}
    
    // Add event listeners for tab switching to load configurations
    document.addEventListener('shown.bs.tab', function(event) {
        const tabId = event.target.getAttribute('data-bs-target');
        if (tabId && tabId.startsWith('#alert-')) {
            const tabNumber = parseInt(tabId.replace('#alert-', ''));
            loadTabConfiguration(tabNumber);
        }
    });
    {% endif %}
});

// Function to save all tabs with auto-incremented amounts
// Save all tabs that have unsaved changes in the form state manager
function saveAllTabsWithChanges(submitButton = null) {
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    const unsavedTabNumbers = Object.keys(formStateManager.states).map(Number);
    
    if (unsavedTabNumbers.length === 0) {
        alert('Хадгалах өөрчлөлт олдсонгүй.');
        return;
    }
    
    
    let savedCount = 0;
    let totalTabs = unsavedTabNumbers.length;
    
    // Save each tab with unsaved changes
    unsavedTabNumbers.forEach(tabNumber => {
        const tabPane = document.getElementById(`alert-${tabNumber}`);
        if (!tabPane) return;
        
        const form = tabPane.querySelector('form');
        if (!form) return;
        
        // Use the saved state directly instead of restoring to form first
        const savedState = formStateManager.states[tabNumber];
        if (!savedState) {
            return;
        }
        
        // Start with the saved state and supplement with current form data
        const data = { ...savedState };
        
        // Also collect current form data for any fields not in saved state
        const formData = new FormData(form);
        const currentFormData = Object.fromEntries(formData.entries());
        
        // Merge current form data, but prioritize saved state for TTS fields
        Object.keys(currentFormData).forEach(key => {
            if (!data.hasOwnProperty(key)) {
                data[key] = currentFormData[key];
            }
        });
        
        // Handle checkboxes explicitly
        const ttsEnabledCheckbox = form.querySelector('#ttsEnabled, [id^="ttsEnabled"]');
        if (ttsEnabledCheckbox) {
            data.tts_enabled = ttsEnabledCheckbox.checked;
        }
        
        // Convert seconds to milliseconds for backend
        if (data.visible_time) {
            data.visible_time = Math.round(parseFloat(data.visible_time) * 1000);
        }
        if (data.animation_speed) {
            data.animation_speed = Math.round(parseFloat(data.animation_speed) * 1000);
        }
        
        // Convert TTS values to numbers with proper validation
        data.tts_speed = data.tts_speed && data.tts_speed !== '' ? parseFloat(data.tts_speed) : 1.0;
        data.tts_pitch = data.tts_pitch && data.tts_pitch !== '' ? parseFloat(data.tts_pitch) : 1.0;
        
        // Ensure they are valid numbers
        if (isNaN(data.tts_speed)) data.tts_speed = 1.0;
        if (isNaN(data.tts_pitch)) data.tts_pitch = 1.0;
        
        // Get tab-specific assets
        const tabAssets = tabAssetSelections[tabNumber] || { selectedGif: null, selectedSound: null };
        
        if (tabAssets.selectedGif) {
            if (tabAssets.selectedGif.is_default) {
                data.default_gif_name = tabAssets.selectedGif.filename;
                data.selected_gif_id = null;
            } else {
                data.selected_gif_id = tabAssets.selectedGif.id;
                data.default_gif_name = null;
            }
        }
        
        if (tabAssets.selectedSound) {
            if (tabAssets.selectedSound.is_default) {
                data.default_sound_name = tabAssets.selectedSound.filename;
                data.selected_sound_id = null;
            } else {
                data.selected_sound_id = tabAssets.selectedSound.id;
                data.default_sound_name = null;
            }
        }
        
        
        // Debug: Check the actual select element values
        const speedSelect = form.querySelector('[name="tts_speed"]');
        const pitchSelect = form.querySelector('[name="tts_pitch"]');
        const voiceSelect = form.querySelector('[name="tts_voice"]');
        
        // Check if the select elements are actually in the FormData
        const formDataEntries = [...formData.entries()];
        const hasSpeed = formDataEntries.some(([name]) => name === 'tts_speed');
        const hasPitch = formDataEntries.some(([name]) => name === 'tts_pitch');
        
        // Debug: Check which options are selected in the HTML
        if (speedSelect) {
            const selectedSpeedOption = speedSelect.querySelector('option:checked') || speedSelect.querySelector('option[selected]');
        }
        if (pitchSelect) {
            const selectedPitchOption = pitchSelect.querySelector('option:checked') || pitchSelect.querySelector('option[selected]');
        }
        
        // Save this tab
        const endpoint = `/donation-alert/configurations/${tabNumber}`;
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(responseData => {
            if (responseData.success) {
                savedCount++;
                
                // Update tab label with new minimum amount
                const minimumAmount = parseFloat(data.minimum_amount) || 0;
                updateTabLabel(tabNumber, minimumAmount);
                
                // Mark tab as saved to database
                tabPane.dataset.saved = 'true';
                
                // Clear saved state for this tab
                formStateManager.clearTabState(tabNumber);
                
                
                // Show success message when all tabs are saved
                if (savedCount === totalTabs) {
                    
                    // Update button state if provided
                    if (submitButton) {
                        const originalText = submitButton.innerHTML;
                        submitButton.innerHTML = '<i class="fas fa-check me-2"></i>Хадгалагдлаа!';
                        submitButton.classList.add('btn-success');
                        submitButton.classList.remove('btn-primary');
                        
                        setTimeout(() => {
                            submitButton.innerHTML = originalText;
                            submitButton.classList.remove('btn-success');
                            submitButton.classList.add('btn-primary');
                        }, 2000);
                    }
                }
            } else {
                alert(`Алерт ${tabNumber} хадгалахад алдаа гарлаа: ` + responseData.error);
            }
        })
        .catch(error => {
            alert(`Алерт ${tabNumber} хадгалахад холболтын алдаа гарлаа: ` + error.message);
        });
    });
    {% endif %}
}

// Save a single tab (for basic users or when no unsaved changes exist)
function saveSingleTab(form) {
    // Get form data with better handling for tab-specific fields
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Debug log to see what data is being collected
    
    // Debug: Check the actual select element values
    const speedSelect = form.querySelector('[name="tts_speed"]');
    const pitchSelect = form.querySelector('[name="tts_pitch"]');
    const voiceSelect = form.querySelector('[name="tts_voice"]');
    
    // Check if the select elements are actually in the FormData
    const formDataEntries = [...formData.entries()];
    const hasSpeed = formDataEntries.some(([name]) => name === 'tts_speed');
    const hasPitch = formDataEntries.some(([name]) => name === 'tts_pitch');
    
    // Handle checkboxes explicitly (FormData doesn't include unchecked checkboxes)
    const ttsEnabledCheckbox = form.querySelector('#ttsEnabled, [id^="ttsEnabled"]');
    if (ttsEnabledCheckbox) {
        data.tts_enabled = ttsEnabledCheckbox.checked;
    }
    
    // Convert seconds to milliseconds for backend
    if (data.visible_time) {
        data.visible_time = Math.round(parseFloat(data.visible_time) * 1000);
    }
    if (data.animation_speed) {
        data.animation_speed = Math.round(parseFloat(data.animation_speed) * 1000);
    }
    
    // Convert TTS values to numbers with proper validation
    data.tts_speed = data.tts_speed && data.tts_speed !== '' ? parseFloat(data.tts_speed) : 1.0;
    data.tts_pitch = data.tts_pitch && data.tts_pitch !== '' ? parseFloat(data.tts_pitch) : 1.0;
    
    // Ensure they are valid numbers
    if (isNaN(data.tts_speed)) data.tts_speed = 1.0;
    if (isNaN(data.tts_pitch)) data.tts_pitch = 1.0;
    
    // Get current tab assets (either global or per-tab)
    const currentAssets = getCurrentTabAssets();
    
    if (currentAssets.selectedGif) {
        if (currentAssets.selectedGif.is_default) {
            data.default_gif_name = currentAssets.selectedGif.filename;
            data.selected_gif_id = null;
        } else {
            data.selected_gif_id = currentAssets.selectedGif.id;
            data.default_gif_name = null;
        }
    }
    
    if (currentAssets.selectedSound) {
        if (currentAssets.selectedSound.is_default) {
            data.default_sound_name = currentAssets.selectedSound.filename;
            data.selected_sound_id = null;
        } else {
            data.selected_sound_id = currentAssets.selectedSound.id;
            data.default_sound_name = null;
        }
    }
    
    // Determine API endpoint based on tier and tab
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Get tab number from the form's parent tab pane (more reliable than UI state)
    const tabPane = form.closest('.tab-pane');
    const tabNumber = tabPane ? parseInt(tabPane.id.replace('alert-', '')) : getCurrentActiveTabNumber();
    const endpoint = `/donation-alert/configurations/${tabNumber}`;
    {% else %}
    const endpoint = '/donation-alert/settings';
    {% endif %}
    
    // Submit settings
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(responseData => {
        if (responseData.success) {
            // Update tab label with new minimum amount for advanced tier
            {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
            // Use the same tab number we just saved to (from form context)
            const minimumAmount = parseFloat(data.minimum_amount) || 0;
            updateTabLabel(tabNumber, minimumAmount);
            
            // Mark tab as saved to database
            const tabPane = document.getElementById(`alert-${tabNumber}`);
            if (tabPane) {
                tabPane.dataset.saved = 'true';
            }
            
            // Clear saved state for this tab
            formStateManager.clearTabState(tabNumber);
            {% endif %}
            
            // Show success message
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Хадгалагдлаа!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-primary');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        } else {
            // Check if it's a duplicate amount error with suggestion
            if (responseData.suggestion && responseData.suggestion_message) {
                const confirmed = confirm(
                    responseData.error + '\n\n' + 
                    responseData.suggestion_message + '\n\n' +
                    'Санал болгох дүнг ашиглах уу? Бусад хадгалагдаагүй алертүүд автоматаар дараалалтайгаар тохируулагдана.'
                );
                
                if (confirmed) {
                    // Save all unsaved tabs with auto-incremented amounts
                    saveAllUnsavedTabs();
                }
            } else {
                alert('Алдаа гарлаа: ' + (responseData.error || 'Тодорхойгүй алдаа'));
            }
        }
    })
    .catch(error => {
        alert('Холболтын алдаа гарлаа: ' + error.message);
    });
}

function saveAllUnsavedTabs() {
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Find all tab panes - save ALL tabs regardless of saved status
    const allTabPanes = document.querySelectorAll('.tab-pane[id^="alert-"]');
    const tabsToSave = Array.from(allTabPanes);
    
    if (tabsToSave.length === 0) {
        return; // Nothing to save
    }
    
    
    // Start with a base amount and increment for each tab
    let currentAmount = 500; // Start at 500₮
    let savedCount = 0;
    
    // Save each tab sequentially
    tabsToSave.forEach((tabPane, index) => {
        const tabNumber = parseInt(tabPane.id.replace('alert-', ''));
        const form = tabPane.querySelector('form');
        
        if (form) {
            // Collect form data FIRST to preserve manual changes
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Only set auto-increment amount if no amount is set or if amount is 0
            const currentMinAmount = parseFloat(data.minimum_amount) || 0;
            if (currentMinAmount === 0) {
                data.minimum_amount = currentAmount;
                currentAmount += 500; // Increment by 500₮ for next tab
            } else {
                // Update currentAmount for next tab to avoid conflicts
                if (currentMinAmount >= currentAmount) {
                    currentAmount = currentMinAmount + 500;
                }
            }
            
            
            // Handle checkboxes explicitly
            const ttsEnabledCheckbox = form.querySelector('#ttsEnabled, [id^="ttsEnabled"]');
            if (ttsEnabledCheckbox) {
                data.tts_enabled = ttsEnabledCheckbox.checked;
            }
            
            // Convert seconds to milliseconds for backend
            if (data.visible_time) {
                data.visible_time = Math.round(parseFloat(data.visible_time) * 1000);
            }
            if (data.animation_speed) {
                data.animation_speed = Math.round(parseFloat(data.animation_speed) * 1000);
            }
            
            // Get current tab assets (this might not work correctly for all tabs)
            // TODO: Fix asset selection for batch save
            const currentAssets = { selectedGif: null, selectedSound: null };
            if (currentAssets.selectedGif) {
                if (currentAssets.selectedGif.is_default) {
                    data.default_gif_name = currentAssets.selectedGif.filename;
                    data.selected_gif_id = null;
                } else {
                    data.selected_gif_id = currentAssets.selectedGif.id;
                    data.default_gif_name = null;
                }
            }
            
            if (currentAssets.selectedSound) {
                if (currentAssets.selectedSound.is_default) {
                    data.default_sound_name = currentAssets.selectedSound.filename;
                    data.selected_sound_id = null;
                } else {
                    data.selected_sound_id = currentAssets.selectedSound.id;
                    data.default_sound_name = null;
                }
            }
            
            // Save this tab
            const endpoint = `/donation-alert/configurations/${tabNumber}`;
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.success) {
                    savedCount++;
                    
                    // Update tab label with new minimum amount
                    const minimumAmount = parseFloat(data.minimum_amount) || 0;
                    updateTabLabel(tabNumber, minimumAmount);
                    
                    // Mark tab as saved to database
                    tabPane.dataset.saved = 'true';
                    
                    // Log success for last tab
                    if (savedCount === tabsToSave.length) {
                    }
                } else {
                    alert(`Алерт ${tabNumber} хадгалахад алдаа гарлаа: ${responseData.error}`);
                }
            })
            .catch(error => {
                alert(`Алерт ${tabNumber} хадгалахад холболтын алдаа гарлаа: ${error.message}`);
            });
        }
    });
    {% endif %}
}

// Helper functions for tab management
function getCurrentActiveTabNumber() {
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        const tabId = activeTab.id;
        const tabNumber = parseInt(tabId.replace('alert-', ''));
        return tabNumber;
    }
    {% endif %}
    return 1; // Default for basic tier or fallback
}

function getCurrentTabAssets() {
    const tabNumber = getCurrentActiveTabNumber();
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    if (!tabAssetSelections[tabNumber]) {
        tabAssetSelections[tabNumber] = { selectedGif: null, selectedSound: null };
    }
    return tabAssetSelections[tabNumber];
    {% else %}
    return { selectedGif: selectedGif, selectedSound: selectedSound };
    {% endif %}
}

function setCurrentTabAssets(gif, sound) {
    const tabNumber = getCurrentActiveTabNumber();
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    if (!tabAssetSelections[tabNumber]) {
        tabAssetSelections[tabNumber] = { selectedGif: null, selectedSound: null };
    }
    if (gif !== undefined) tabAssetSelections[tabNumber].selectedGif = gif;
    if (sound !== undefined) tabAssetSelections[tabNumber].selectedSound = sound;
    {% else %}
    if (gif !== undefined) selectedGif = gif;
    if (sound !== undefined) selectedSound = sound;
    {% endif %}
}

// Load configuration for specific tab
function loadTabConfiguration(tabNumber) {
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    if (tabNumber === 1) {
        // Tab 1 loads from the initial page data, no need to fetch
        return;
    }
    
    fetch(`/donation-alert/configurations/${tabNumber}`)
        .then(response => {
            if (response.ok) {
                return response.json();
            } else if (response.status === 404) {
                // Expected for new tabs - silently continue with defaults
                return { success: false };
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        })
        .then(data => {
            if (data.success && data.configuration) {
                populateTabForm(tabNumber, data.configuration);
            } else {
                // Tab will use default values from the form
            }
        })
        .catch(error => {
            // Only log unexpected errors (not 404s for new tabs)
        });
    {% endif %}
}

function populateTabForm(tabNumber, config) {
    const tabPane = document.getElementById(`alert-${tabNumber}`);
    if (!tabPane) return;
    
    // Check if there are unsaved changes for this tab - if so, don't overwrite
    if (formStateManager.hasUnsavedChanges(tabNumber)) {
        return;
    }
    
    
    // Populate form fields
    Object.keys(config).forEach(key => {
        const input = tabPane.querySelector(`[name="${key}"]`);
        if (input) {
            if (input.type === 'checkbox') {
                input.checked = config[key];
            } else if (input.type === 'range') {
                input.value = config[key];
                // Update range display
                const displayId = input.id.replace(/(_tab\d+)?$/, 'Display').replace('_tab', '');
                const display = tabPane.querySelector(`#${displayId}, [id$="${displayId}"]`);
                if (display) {
                    const unit = input.id.includes('Size') ? '%' : (input.id.includes('Volume') ? '%' : '');
                    display.textContent = config[key] + unit;
                }
            } else {
                // Convert milliseconds back to seconds for UI
                if (key === 'visible_time' || key === 'animation_speed') {
                    input.value = (config[key] / 1000).toFixed(1);
                } else {
                    input.value = config[key];
                }
                
                // For select elements, ensure the correct option is selected
                if (input.tagName === 'SELECT') {
                    // Special handling for TTS fields - convert numbers to proper string format
                    let valueToMatch = config[key];
                    if ((key === 'tts_speed' || key === 'tts_pitch') && typeof valueToMatch === 'number') {
                        // Convert 1 -> "1.0", 0.5 -> "0.5", etc.
                        valueToMatch = valueToMatch.toFixed(1);
                        if (valueToMatch.endsWith('.0')) {
                            // Keep it as "1.0" for exact matching
                        }
                    }
                    
                    const optionToSelect = input.querySelector(`option[value="${valueToMatch}"]`);
                    if (optionToSelect) {
                        // Clear any existing selection
                        Array.from(input.options).forEach(option => option.selected = false);
                        // Select the correct option
                        optionToSelect.selected = true;
                        input.value = valueToMatch; // Use the converted value, not the original
                        
                        // Debug TTS fields specifically
                        if (key === 'tts_speed' || key === 'tts_pitch' || key === 'tts_voice') {
                        }
                    } else if (key === 'tts_speed' || key === 'tts_pitch' || key === 'tts_voice') {
                    }
                }
            }
        }
    });
    
    // Load assets for this tab
    
    if (config.selected_gif_id || config.default_gif_name) {
        // Find and set the GIF asset
        let gifAsset = null;
        if (config.selected_gif_id) {
            gifAsset = window.userGifs.find(gif => gif.id === config.selected_gif_id);
        } else if (config.default_gif_name) {
            gifAsset = window.defaultGifs.find(gif => gif.filename === config.default_gif_name);
            if (gifAsset) gifAsset.is_default = true;
        }
        
        if (gifAsset) {
            if (!tabAssetSelections[tabNumber]) {
                tabAssetSelections[tabNumber] = { selectedGif: null, selectedSound: null };
            }
            tabAssetSelections[tabNumber].selectedGif = gifAsset;
        }
    }
    
    if (config.selected_sound_id || config.default_sound_name) {
        // Find and set the sound asset
        let soundAsset = null;
        if (config.selected_sound_id) {
            soundAsset = window.userSounds.find(sound => sound.id === config.selected_sound_id);
        } else if (config.default_sound_name) {
            soundAsset = window.defaultSounds.find(sound => sound.filename === config.default_sound_name);
            if (soundAsset) soundAsset.is_default = true;
        }
        
        if (soundAsset) {
            if (!tabAssetSelections[tabNumber]) {
                tabAssetSelections[tabNumber] = { selectedGif: null, selectedSound: null };
            }
            tabAssetSelections[tabNumber].selectedSound = soundAsset;
        }
    }
    
    // Update asset previews for this tab
    updateAssetPreviews(tabNumber);
    
    // Update tab label with minimum amount
    updateTabLabel(tabNumber, config.minimum_amount || 0);
    
    // Update preview
    updatePreview();
}

function updateAssetPreviews(tabNumber) {
    const tabPane = document.getElementById(`alert-${tabNumber}`);
    if (!tabPane) return;
    
    const assets = tabAssetSelections[tabNumber];
    if (!assets) return;
    
    // Update GIF preview
    const gifPreview = tabPane.querySelector('[id^="selectedGifPreview"]');
    const gifImage = tabPane.querySelector('[id^="selectedGifImage"]');
    const gifName = tabPane.querySelector('[id^="selectedGifName"]');
    
    if (assets.selectedGif && gifPreview && gifImage && gifName) {
        gifImage.src = assets.selectedGif.url;
        gifImage.style.display = 'block';
        gifName.textContent = assets.selectedGif.display_name || assets.selectedGif.filename;
    }
    
    // Update sound preview
    const soundPreview = tabPane.querySelector('[id^="selectedSoundPreview"]');
    const soundIcon = tabPane.querySelector('[id^="selectedSoundIcon"]');
    const soundName = tabPane.querySelector('[id^="selectedSoundName"]');
    const playBtn = tabPane.querySelector('[id^="playSoundBtn"]');
    
    if (assets.selectedSound && soundPreview && soundIcon && soundName && playBtn) {
        soundIcon.style.display = 'inline';
        soundName.textContent = assets.selectedSound.display_name || assets.selectedSound.filename;
        playBtn.style.display = 'inline-block';
    }
}

function updateTabLabel(tabNumber, minimumAmount) {
    const tabButton = document.getElementById(`alert-${tabNumber}-tab`);
    if (!tabButton) return;
    
    const formattedAmount = formatAmount(minimumAmount);
    const icon = tabButton.querySelector('i');
    const closeBtn = tabButton.querySelector('.btn-close');
    
    // Update the tab text while preserving the icon and close button
    const iconHTML = icon ? icon.outerHTML : '<i class="fas fa-bell me-1"></i>';
    const closeBtnHTML = closeBtn ? closeBtn.outerHTML : '';
    
    tabButton.innerHTML = `${iconHTML}Алерт ${tabNumber} (${formattedAmount})${closeBtnHTML}`;
}

// Tab Management Functions
function createTabFromConfig(config) {
    const tabNumber = config.tab_number;
    const tabId = 'alert-' + tabNumber;
    const minimumAmount = config.minimum_amount || 0;
    const formattedAmount = formatAmount(minimumAmount);
    
    // Update alertTabCounter to match highest tab number
    if (tabNumber > alertTabCounter) {
        alertTabCounter = tabNumber;
    }
    
    // Initialize asset selections for this tab
    tabAssetSelections[tabNumber] = {
        selectedGif: config.selected_gif_id ? {
            id: config.selected_gif_id,
            url: config.gif_url,
            is_default: false
        } : {
            filename: config.default_gif_name,
            url: config.gif_url,
            is_default: true
        },
        selectedSound: config.selected_sound_id ? {
            id: config.selected_sound_id,
            url: config.sound_url,
            is_default: false
        } : {
            filename: config.default_sound_name,
            url: config.sound_url,
            is_default: true
        }
    };
    
    // Create new tab button
    const tabsList = document.getElementById('alertTabs');
    const addTabItem = tabsList.querySelector('.add-tab-item');
    
    const newTabItem = document.createElement('li');
    newTabItem.className = 'nav-item';
    newTabItem.setAttribute('role', 'presentation');
    newTabItem.innerHTML = `
        <button class="nav-link" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" 
                type="button" role="tab" aria-controls="${tabId}" aria-selected="false">
            <i class="fas fa-bell me-1"></i>Алерт ${tabNumber} (${formattedAmount})
            <button class="btn btn-sm btn-outline-danger ms-2 tab-close-btn" onclick="removeAlertTab('${tabId}', event)">
                <i class="fas fa-times"></i>
            </button>
        </button>
    `;
    
    // Insert before the add button
    tabsList.insertBefore(newTabItem, addTabItem);
    
    // Create new tab content
    const tabContent = document.getElementById('alertTabContent');
    const newTabPane = document.createElement('div');
    newTabPane.className = 'tab-pane fade';
    newTabPane.id = tabId;
    newTabPane.setAttribute('role', 'tabpanel');
    newTabPane.setAttribute('aria-labelledby', tabId + '-tab');
    
    // Clone the first tab's content structure
    const firstTab = document.getElementById('alert-1');
    newTabPane.innerHTML = firstTab.innerHTML;
    
    // Update form IDs to make them unique
    updateTabFormIds(newTabPane, tabNumber);
    
    // Mark as saved since this comes from database configuration
    newTabPane.dataset.saved = 'true';
    
    tabContent.appendChild(newTabPane);
    
    // Populate the tab with saved configuration
    populateTabForm(tabNumber, config);
    
}

function addNewAlertTab() {
    if (alertTabCounter >= maxAlertTabs) {
        alert('Хамгийн ихдээ ' + maxAlertTabs + ' алерт нэмж болно.');
        return;
    }
    
    alertTabCounter++;
    const tabId = 'alert-' + alertTabCounter;
    const tabLabel = 'Алерт ' + alertTabCounter;
    
    // Initialize asset selections for new tab
    tabAssetSelections[alertTabCounter] = {
        selectedGif: null,
        selectedSound: null
    };
    
    // Create new tab button
    const tabsList = document.getElementById('alertTabs');
    const addTabItem = tabsList.querySelector('.add-tab-item');
    
    const newTabItem = document.createElement('li');
    newTabItem.className = 'nav-item';
    newTabItem.setAttribute('role', 'presentation');
    newTabItem.innerHTML = `
        <button class="nav-link" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" 
                type="button" role="tab" aria-controls="${tabId}" aria-selected="false">
            <i class="fas fa-bell me-1"></i>${tabLabel} (₮0+)
            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 10px;" onclick="removeAlertTab('${tabId}', event)"></button>
        </button>
    `;
    
    // Insert before the add button
    tabsList.insertBefore(newTabItem, addTabItem);
    
    // Create new tab content
    const tabContent = document.getElementById('alertTabContent');
    const newTabPane = document.createElement('div');
    newTabPane.className = 'tab-pane fade';
    newTabPane.id = tabId;
    newTabPane.setAttribute('role', 'tabpanel');
    newTabPane.setAttribute('aria-labelledby', tabId + '-tab');
    
    // Clone the first tab's content structure
    const firstTab = document.getElementById('alert-1');
    newTabPane.innerHTML = firstTab.innerHTML;
    
    // Update form IDs to make them unique
    updateTabFormIds(newTabPane, alertTabCounter);
    
    tabContent.appendChild(newTabPane);
    
    // Immediately ensure this new form has event listeners (defensive programming)
    const newForm = newTabPane.querySelector('form');
    if (newForm && !newForm.dataset.listenersAdded) {
        newForm.addEventListener('submit', function(e) {
            e.preventDefault();
        });
    }
    
    // Activate the new tab
    const newTab = new bootstrap.Tab(document.getElementById(tabId + '-tab'));
    newTab.show();
    
    // Update current active tab
    currentActiveTab = alertTabCounter;
    
    // Update the preview to show the new tab's default assets immediately
    setTimeout(() => {
        updatePreview();
    }, 100);
    
}

function removeAlertTab(tabId, event) {
    event.stopPropagation();
    
    if (tabId === 'alert-1') {
        alert('Үндсэн алерт устгах боломжгүй.');
        return;
    }
    
    if (confirm('Та энэ алертыг устгахыг хүсэж байна уу?')) {
        const tabNumber = parseInt(tabId.replace('alert-', ''));
        
        {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
        // Check if this tab exists in the database by checking if it was ever saved
        const tabPane = document.getElementById(tabId);
        const wasSavedToDatabase = tabPane && tabPane.dataset.saved === 'true';
        
        if (wasSavedToDatabase) {
            // Tab exists in database - call backend API to delete
            fetch(`/donation-alert/configurations/${tabNumber}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    removeTabFromUI(tabId, tabNumber);
                } else {
                    alert('Алдаа гарлаа: ' + (data.error || 'Тодорхойгүй алдаа'));
                }
            })
            .catch(error => {
                alert('Холболтын алдаа гарлаа');
            });
        } else {
            // Tab only exists in UI - just remove from frontend
            removeTabFromUI(tabId, tabNumber);
        }
        {% endif %}
    }
}

function removeTabFromUI(tabId, tabNumber) {
    // Check if the tab being removed is currently active
    const tabButton = document.getElementById(tabId + '-tab');
    const isActiveTab = tabButton && tabButton.classList.contains('active');
    
    // Remove tab button
    if (tabButton) {
        tabButton.closest('.nav-item').remove();
    }
    
    // Remove tab content
    const tabPane = document.getElementById(tabId);
    if (tabPane) {
        tabPane.remove();
    }
    
    // Remove from asset selections
    if (typeof tabAssetSelections !== 'undefined') {
        delete tabAssetSelections[tabNumber];
    }
    
    // If the removed tab was active, activate the nearest tab to the left
    if (isActiveTab) {
        activateNearestTabToLeft(tabNumber);
    }
}

function activateNearestTabToLeft(deletedTabNumber) {
    // Get all remaining tab buttons in order
    const tabsList = document.getElementById('alertTabs');
    const remainingTabs = Array.from(tabsList.querySelectorAll('.nav-link:not(.add-tab-btn)'));
    
    // Extract tab numbers and sort them
    const availableTabNumbers = remainingTabs
        .map(button => {
            const targetId = button.getAttribute('data-bs-target');
            if (targetId && targetId.startsWith('#alert-')) {
                return parseInt(targetId.replace('#alert-', ''));
            }
            return null;
        })
        .filter(num => num !== null)
        .sort((a, b) => a - b);
    
    
    // Find the nearest tab to the left
    let targetTabNumber = null;
    
    // Look for the highest tab number that is less than the deleted tab number
    for (let i = availableTabNumbers.length - 1; i >= 0; i--) {
        if (availableTabNumbers[i] < deletedTabNumber) {
            targetTabNumber = availableTabNumbers[i];
            break;
        }
    }
    
    // If no tab to the left exists, select the first available tab
    if (targetTabNumber === null && availableTabNumbers.length > 0) {
        targetTabNumber = availableTabNumbers[0];
    }
    
    
    // Activate the target tab
    if (targetTabNumber !== null) {
        const targetTabButton = document.getElementById(`alert-${targetTabNumber}-tab`);
        if (targetTabButton) {
            const tab = new bootstrap.Tab(targetTabButton);
            tab.show();
        }
    }
}

function updateTabFormIds(tabElement, tabNumber) {
    // Update form and input IDs to make them unique for each tab
    const form = tabElement.querySelector('form');
    if (form) {
        form.id = 'alertSettingsForm' + tabNumber;
        
        // IMPORTANT: Clear the listenersAdded flag from the cloned form
        // so that new event listeners can be properly attached
        delete form.dataset.listenersAdded;
        
        // Ensure form has defensive onsubmit handler as backup
        form.setAttribute('onsubmit', 'return false;');
    }
    
    // Update all input IDs and their corresponding labels
    const inputs = tabElement.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.id) {
            const newId = input.id + '_tab' + tabNumber;
            const oldId = input.id;
            input.id = newId;
            
            // Update corresponding label
            const label = tabElement.querySelector(`label[for="${oldId}"]`);
            if (label) {
                label.setAttribute('for', newId);
            }
        }
    });
    
    // Update preview container ID
    const previewAlert = tabElement.querySelector('#previewAlert');
    if (previewAlert) {
        previewAlert.id = 'previewAlert' + tabNumber;
    }
    
    // Update TTS usage display element IDs
    const ttsUsageDisplay = tabElement.querySelector('#ttsUsageDisplay');
    if (ttsUsageDisplay) {
        ttsUsageDisplay.id = 'ttsUsageDisplay_tab' + tabNumber;
    }
    
    // Update all TTS usage statistic element IDs
    const ttsStatElements = [
        'dailyUsage', 'dailyLimit', 'dailyChars', 'dailyCharLimit',
        'monthlyUsage', 'monthlyLimit', 'monthlyChars', 'monthlyCharLimit'
    ];
    
    ttsStatElements.forEach(elementId => {
        const element = tabElement.querySelector('#' + elementId);
        if (element) {
            element.id = elementId + '_tab' + tabNumber;
        }
    });
    
    // Note: Event listeners are handled by setupFormEventListeners() to prevent duplicates
}

function initializeAssetSelections() {
    // Initialize GIF selection and preview from current settings
    if (currentSettings.selected_gif_id) {
        // Set selectedGif from user asset
        selectedGif = {
            id: currentSettings.selected_gif_id,
            url: currentSettings.gif_url,
            is_default: false
        };
        
        // Update preview directly from settings
        const previewImg = document.getElementById('selectedGifImage');
        const previewName = document.getElementById('selectedGifName');
        previewImg.src = currentSettings.gif_url;
        previewImg.style.display = 'block';
        previewName.textContent = 'Сонгосон зураг'; // Selected image
        
    } else if (currentSettings.default_gif_name) {
        // Set selectedGif from default asset
        selectedGif = {
            filename: currentSettings.default_gif_name,
            url: currentSettings.gif_url,
            is_default: true
        };
        
        // Update preview directly from settings
        const previewImg = document.getElementById('selectedGifImage');
        const previewName = document.getElementById('selectedGifName');
        previewImg.src = currentSettings.gif_url;
        previewImg.style.display = 'block';
        previewName.textContent = currentSettings.default_gif_name;
    }
    
    // Initialize Sound selection and preview from current settings
    if (currentSettings.selected_sound_id) {
        // Set selectedSound from user asset
        selectedSound = {
            id: currentSettings.selected_sound_id,
            url: currentSettings.sound_url,
            is_default: false
        };
        
        // Update preview directly from settings
        const previewIcon = document.getElementById('selectedSoundIcon');
        const previewName = document.getElementById('selectedSoundName');
        const playBtn = document.getElementById('playSoundBtn');
        
        previewIcon.style.display = 'inline-block';
        previewName.textContent = 'Сонгосон дуу'; // Selected sound
        playBtn.style.display = 'inline-block';
        
    } else if (currentSettings.default_sound_name) {
        // Set selectedSound from default asset
        selectedSound = {
            filename: currentSettings.default_sound_name,
            url: currentSettings.sound_url,
            is_default: true
        };
        
        // Update preview directly from settings
        const previewIcon = document.getElementById('selectedSoundIcon');
        const previewName = document.getElementById('selectedSoundName');
        const playBtn = document.getElementById('playSoundBtn');
        
        previewIcon.style.display = 'inline-block';
        previewName.textContent = currentSettings.default_sound_name;
        playBtn.style.display = 'inline-block';
    }
    
    // Add click handlers for asset selection
    document.querySelectorAll('.asset-item:not(.asset-upload)').forEach(item => {
        item.addEventListener('click', function() {
            selectAsset(this);
        });
    });
}

function selectAsset(element) {
    const gallery = element.closest('.asset-gallery');
    const assetType = gallery.dataset.type;
    
    // Remove previous selection
    gallery.querySelectorAll('.asset-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Add selection to clicked item
    element.classList.add('selected');
    
    // Update selection variables
    if (assetType === 'gif') {
        if (element.dataset.id) {
            selectedGif = {
                id: parseInt(element.dataset.id),
                url: element.dataset.url,
                is_default: false
            };
        } else {
            selectedGif = {
                filename: element.dataset.filename,
                url: element.dataset.url,
                is_default: true
            };
        }
    } else if (assetType === 'sound') {
        if (element.dataset.id) {
            selectedSound = {
                id: parseInt(element.dataset.id),
                url: element.dataset.url,
                is_default: false
            };
        } else {
            selectedSound = {
                filename: element.dataset.filename,
                url: element.dataset.url,
                is_default: true
            };
        }
    }
    
    updatePreview();
}

function updateRangeDisplay(rangeId, displayId, suffix) {
    const range = document.getElementById(rangeId);
    const display = document.getElementById(displayId);
    
    function update() {
        display.textContent = range.value + suffix;
    }
    
    range.addEventListener('input', update);
    update(); // Initial update
}

function setupRangeDisplaysForForm(form) {
    // Set up range displays for all range inputs in this form
    const ranges = [
        { inputName: 'image_size', displayId: 'imageSizeDisplay', suffix: '%' },
        { inputName: 'sound_volume', displayId: 'soundVolumeDisplay', suffix: '%' }
    ];
    
    ranges.forEach(({ inputName, displayId, suffix }) => {
        const rangeInput = form.querySelector(`[name="${inputName}"]`);
        const display = form.querySelector(`#${displayId}`);
        
        if (rangeInput && display) {
            // Remove any existing listener to prevent duplicates
            const newRangeInput = rangeInput.cloneNode(true);
            rangeInput.parentNode.replaceChild(newRangeInput, rangeInput);
            
            // Add the event listener
            function updateDisplay() {
                display.textContent = newRangeInput.value + suffix;
            }
            
            newRangeInput.addEventListener('input', updateDisplay);
            updateDisplay(); // Initial update
        }
    });
}

function updatePreview() {
    // Find the currently active form (either basic tier or active tab)
    let activeForm;
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Advanced tier - find active tab form
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        activeForm = activeTab.querySelector('form');
    }
    {% else %}
    // Basic tier - use the main form
    activeForm = document.getElementById('alertSettingsForm');
    {% endif %}
    
    if (!activeForm) {
        return;
    }
    
    const formData = new FormData(activeForm);
    
    // Sample donation data
    const sampleDonation = {
        name: 'Бат-Эрдэнэ',
        amount: 5000,
        message: 'Сайхан stream байна!'
    };
    
    // Get current form values
    const template = formData.get('text_template') || currentSettings.text_template || '{name}-ээс **[{amount}₮]** donation орж ирлээ!';
    const position = formData.get('image_position') || currentSettings.image_position;
    const imageSize = formData.get('image_size') || currentSettings.image_size;
    const transitionType = formData.get('transition_type') || currentSettings.transition_type;
    
    // Get current tab's assets
    const tabAssets = getCurrentTabAssets();
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // For advanced tier: use per-tab assets (null means use default)
    const currentGif = tabAssets.selectedGif;
    const currentSound = tabAssets.selectedSound;
    {% else %}
    // For basic tier: use global assets with fallback
    const currentGif = tabAssets.selectedGif || selectedGif;
    const currentSound = tabAssets.selectedSound || selectedSound;
    {% endif %}
    
    // Get all styling settings
    const previewSettings = {
        text_template: template,
        image_position: position,
        image_size: parseInt(imageSize) || currentSettings.image_size,
        transition_type: transitionType,
        {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
        gif_url: currentGif ? currentGif.url : '/static/assets/default/gifs/party.gif',
        {% else %}
        gif_url: currentGif ? currentGif.url : (currentSettings.gif_url || '/static/assets/default/gifs/party.gif'),
        {% endif %}
        
        // Donator settings
        donator_image_size: parseInt(formData.get('donator_image_size')) || currentSettings.donator_image_size,
        donator_name_size: parseInt(formData.get('donator_name_size')) || currentSettings.donator_name_size,
        donator_name_weight: formData.get('donator_name_weight') || currentSettings.donator_name_weight,
        donator_alignment: formData.get('donator_alignment') || currentSettings.donator_alignment,
        donator_color: formData.get('donator_color') || currentSettings.donator_color,
        
        // Template style settings
        template_size: parseInt(formData.get('template_size')) || currentSettings.template_size,
        template_weight: formData.get('template_weight') || currentSettings.template_weight,
        template_alignment: formData.get('template_alignment') || currentSettings.template_alignment,
        template_accent_color: formData.get('template_accent_color') || currentSettings.template_accent_color,
        template_base_color: formData.get('template_base_color') || currentSettings.template_base_color,
        
        // Message style settings
        message_size: parseInt(formData.get('message_size')) || currentSettings.message_size,
        message_weight: formData.get('message_weight') || currentSettings.message_weight,
        message_alignment: formData.get('message_alignment') || currentSettings.message_alignment,
        message_style: formData.get('message_style') || currentSettings.message_style,
        message_color: formData.get('message_color') || currentSettings.message_color
    };
    
    // Generate preview HTML
    generateAlertPreview(sampleDonation, previewSettings);
}

function generateAlertPreview(donation, settings) {
    // Find the correct preview container (either basic tier or active tab)
    let previewAlert;
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Advanced tier - find active tab preview
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        previewAlert = activeTab.querySelector('#previewAlert, [id^="previewAlert"]');
    }
    {% else %}
    // Basic tier - use the main preview
    previewAlert = document.getElementById('previewAlert');
    {% endif %}
    
    if (!previewAlert) {
        return;
    }
    
    // Process template variables first
    let processedText = settings.text_template
        .replace(/{name}/g, donation.name)
        .replace(/{amount}/g, donation.amount.toLocaleString());
    
    
    // Apply text formatting
    processedText = processedText
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **text** -> bold
        .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *text* -> italic
        .replace(/\[(.*?)\]/g, `<span style="color: ${settings.template_accent_color}">$1</span>`); // [text] -> accent color
    
    
    // Create HTML structure with full styling
    const alertHTML = `
        <!-- Donator Profile (if we have donator name) -->
        <div class="donator-profile mb-3" style="
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: ${settings.donator_alignment};
        ">
            <img src="/static/assets/default/avatar.png" alt="Donator" style="
                width: ${settings.donator_image_size}px;
                height: ${settings.donator_image_size}px;
                border-radius: 50%;
                border: 2px solid #6366f1;
                object-fit: cover;
            ">
            <div style="
                font-size: ${settings.donator_name_size}px;
                font-weight: ${settings.donator_name_weight};
                color: ${settings.donator_color};
            ">${donation.name}</div>
        </div>

        <!-- Main Alert Content -->
        <div class="d-flex align-items-center gap-3" style="
            flex-direction: ${settings.image_position === 'top' ? 'column' : 
                           settings.image_position === 'bottom' ? 'column-reverse' : 'row'};
            text-align: ${settings.template_alignment};
        ">
            ${settings.image_position === 'right' ? 
                `<div class="alert-content" style="
                    color: ${settings.template_base_color};
                    font-size: ${settings.template_size}px;
                    font-weight: ${settings.template_weight};
                    text-align: ${settings.template_alignment};
                ">${processedText}</div>` : ''}
            
            <div class="alert-image">
                <img src="${settings.gif_url}" alt="Donation GIF" style="
                    width: ${Math.round(120 * settings.image_size / 100)}px;
                    height: ${Math.round(120 * settings.image_size / 100)}px;
                    object-fit: cover;
                    border-radius: 8px;
                ">
            </div>
            
            ${settings.image_position !== 'right' ? 
                `<div class="alert-content" style="
                    color: ${settings.template_base_color};
                    font-size: ${settings.template_size}px;
                    font-weight: ${settings.template_weight};
                    text-align: ${settings.template_alignment};
                ">${processedText}</div>` : ''}
        </div>
        
        ${donation.message ? `<div class="alert-message mt-3" style="
            color: ${settings.message_color};
            font-size: ${settings.message_size}px;
            font-weight: ${settings.message_weight};
            text-align: ${settings.message_alignment};
            font-style: ${settings.message_style};
            opacity: 0.9;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        ">"${donation.message}"</div>` : ''}
    `;
    
    previewAlert.innerHTML = alertHTML;
    previewAlert.className = 'donation-alert';
    previewAlert.style.display = 'block';
    previewAlert.style.opacity = '1';
}

// Test alert function - sends real WebSocket event to overlay
function testAlert() {
    // Initialize socket connection if not already done
    if (typeof io === 'undefined') {
        alert('Socket.IO не ачааллагдсан байна');
        return;
    }
    
    if (!window.testSocket) {
        window.testSocket = io();
    }
    
    // Get current settings for test alert
    const testData = {
        user_id: {{ current_user.id }},
        donator_name: 'Тест хэрэглэгч',
        amount: 25000,
        message: 'Энэ бол туршилтын донейт мессеж! 🎉',
        is_test: true
    };
    
    // For advanced tier, get current tab info and configuration
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        const tabNumber = parseInt(activeTab.id.replace('alert-', ''));
        testData.tab_number = tabNumber;
        
        // Get minimum amount from current tab
        const minimumAmountInput = activeTab.querySelector('[name="minimum_amount"]');
        let minAmount = 0;
        if (minimumAmountInput && minimumAmountInput.value) {
            minAmount = parseFloat(minimumAmountInput.value);
            if (minAmount > 0 && testData.amount < minAmount) {
                // Adjust test amount to be above minimum
                testData.amount = Math.max(minAmount + 1000, 25000);
            }
        }
        
        // Set message to match tab name format: "Алерт X (₮Amount+)"
        testData.message = `Алерт ${tabNumber} (₮${minAmount}+)`;
        
        // Include tab-specific configuration ID if available
        // Look for existing configuration for this tab from backend data
        {% if alert_configurations %}
        const alertConfigs = {{ alert_configurations | tojson }};
        
        const tabConfig = alertConfigs.find(c => c.tab_number === tabNumber);
        if (tabConfig) {
            testData.config_id = tabConfig.id;
        } else {
        }
        {% endif %}
    }
    {% endif %}
    
    
    // Send test alert via WebSocket
    window.testSocket.emit('test_alert', testData);
    
    // Show user feedback
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-1"></i>Илгээгдлээ!';
    btn.classList.add('btn-success');
    btn.classList.remove('btn-outline-primary');
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-primary');
    }, 2000);
}

// Asset modal management
let currentModalType = 'gif';
let selectedModalAsset = null;

function openAssetModal(type) {
    currentModalType = type;
    selectedModalAsset = null;
    
    const modal = new bootstrap.Modal(document.getElementById('assetModal'));
    const modalTitle = document.getElementById('assetModalLabel');
    const confirmBtn = document.getElementById('confirmSelectBtn');
    
    modalTitle.textContent = type === 'gif' ? 'Зураг сонгох' : 'Дуу сонгох';
    confirmBtn.disabled = true;
    
    // Update allowed file types display
    const allowedTypes = type === 'gif' ? 'GIF, PNG, JPEG' : 'MP3, WAV, OGG';
    const maxSize = type === 'gif' ? '35MB' : '5MB';
    
    document.getElementById('allowedTypes').textContent = allowedTypes;
    document.getElementById('maxSize').textContent = maxSize;
    
    // Update asset counts immediately
    const userAssets = currentModalType === 'gif' ? window.userGifs : window.userSounds;
    const defaultAssets = currentModalType === 'gif' ? window.defaultGifs : window.defaultSounds;
    
    
    document.getElementById('userAssetCount').textContent = userAssets.length;
    document.getElementById('defaultAssetCount').textContent = defaultAssets.length;
    
    // Load assets and activate user tab
    switchAssetTab('user');
    
    modal.show();
}

function switchAssetTab(tabType) {
    const userTab = document.getElementById('userAssetsTab');
    const defaultTab = document.getElementById('defaultAssetsTab');
    const gallery = document.getElementById('modalAssetGallery');
    
    // Update tab styles
    if (tabType === 'user') {
        userTab.classList.add('btn-primary');
        userTab.classList.remove('btn-outline-primary');
        defaultTab.classList.add('btn-outline-primary');
        defaultTab.classList.remove('btn-primary');
    } else {
        defaultTab.classList.add('btn-primary');
        defaultTab.classList.remove('btn-outline-primary');
        userTab.classList.add('btn-outline-primary');
        userTab.classList.remove('btn-primary');
    }
    
    // Load assets
    if (tabType === 'user') {
        loadUserAssets();
    } else {
        loadDefaultAssets();
    }
}

function loadUserAssets() {
    const gallery = document.getElementById('modalAssetGallery');
    const assets = currentModalType === 'gif' ? window.userGifs : window.userSounds;
    const countSpan = document.getElementById('userAssetCount');
    
    countSpan.textContent = assets.length;
    
    // Clear gallery and ensure it has the grid class
    gallery.innerHTML = '';
    gallery.className = 'asset-modal-gallery';
    
    // Force grid layout with inline styles to override any conflicting CSS
    gallery.style.display = 'grid';
    gallery.style.gridTemplateColumns = 'repeat(auto-fill, minmax(120px, 1fr))';
    gallery.style.gap = '10px';
    gallery.style.padding = '10px';
    
    
    assets.forEach(asset => {
        const assetDiv = document.createElement('div');
        assetDiv.className = 'asset-item';
        assetDiv.dataset.id = asset.id;
        assetDiv.dataset.url = asset.url;
        assetDiv.onclick = () => selectModalAsset(assetDiv, false);
        
        if (currentModalType === 'gif') {
            assetDiv.innerHTML = `
                <img src="${asset.url}" alt="${asset.filename}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                <div class="asset-name mt-1">${asset.filename}</div>
                <button class="btn btn-sm btn-danger" onclick="deleteModalAsset(event, ${asset.id})" style="position: absolute; top: 5px; right: 5px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else {
            assetDiv.innerHTML = `
                <i class="fas fa-music fa-3x mb-2" style="color: #6366f1;"></i>
                <div class="asset-name">${asset.filename}</div>
                <button class="btn btn-sm btn-secondary" onclick="playModalSound(event, '${asset.url}')" style="margin: 5px;">
                    <i class="fas fa-play"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteModalAsset(event, ${asset.id})" style="position: absolute; top: 5px; right: 5px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
        }
        
        gallery.appendChild(assetDiv);
    });
}

function loadDefaultAssets() {
    const gallery = document.getElementById('modalAssetGallery');
    const assets = currentModalType === 'gif' ? window.defaultGifs : window.defaultSounds;
    const countSpan = document.getElementById('defaultAssetCount');
    
    countSpan.textContent = assets.length;
    
    // Clear gallery and ensure it has the grid class
    gallery.innerHTML = '';
    gallery.className = 'asset-modal-gallery';
    
    // Force grid layout with inline styles to override any conflicting CSS
    gallery.style.display = 'grid';
    gallery.style.gridTemplateColumns = 'repeat(auto-fill, minmax(120px, 1fr))';
    gallery.style.gap = '10px';
    gallery.style.padding = '10px';
    
    
    assets.forEach(asset => {
        const assetDiv = document.createElement('div');
        assetDiv.className = 'asset-item';
        assetDiv.dataset.filename = asset.filename;
        assetDiv.dataset.url = asset.url;
        assetDiv.onclick = () => selectModalAsset(assetDiv, true);
        
        if (currentModalType === 'gif') {
            assetDiv.innerHTML = `
                <img src="${asset.url}" alt="${asset.filename}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                <div class="asset-name mt-1">${asset.filename}</div>
            `;
        } else {
            assetDiv.innerHTML = `
                <i class="fas fa-music fa-3x mb-2" style="color: #6366f1;"></i>
                <div class="asset-name">${asset.filename}</div>
                <button class="btn btn-sm btn-secondary" onclick="playModalSound(event, '${asset.url}')" style="margin: 5px;">
                    <i class="fas fa-play"></i>
                </button>
            `;
        }
        
        gallery.appendChild(assetDiv);
    });
}

function selectModalAsset(element, isDefault) {
    // Remove previous selection
    document.querySelectorAll('#modalAssetGallery .asset-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Add selection to clicked item
    element.classList.add('selected');
    
    // Store selection
    if (isDefault) {
        selectedModalAsset = {
            filename: element.dataset.filename,
            url: element.dataset.url,
            is_default: true
        };
    } else {
        selectedModalAsset = {
            id: parseInt(element.dataset.id),
            url: element.dataset.url,
            is_default: false
        };
    }
    
    // Enable confirm button
    document.getElementById('confirmSelectBtn').disabled = false;
}

function confirmAssetSelection() {
    if (!selectedModalAsset) return;
    
    if (currentModalType === 'gif') {
        // Set asset for current tab
        setCurrentTabAssets(selectedModalAsset, undefined);
        
        // Update preview in the current tab's form
        let previewImg, previewName;
        
        {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
        const activeTab = document.querySelector('.tab-pane.active');
        if (activeTab) {
            previewImg = activeTab.querySelector('#selectedGifImage, [id^="selectedGifImage"]');
            previewName = activeTab.querySelector('#selectedGifName, [id^="selectedGifName"]');
        }
        {% else %}
        previewImg = document.getElementById('selectedGifImage');
        previewName = document.getElementById('selectedGifName');
        {% endif %}
        
        if (previewImg && previewName) {
            previewImg.src = selectedModalAsset.url;
            previewImg.style.display = 'block';
            previewName.textContent = selectedModalAsset.filename || 'Сонгосон зураг';
        }
    } else {
        // Set asset for current tab
        setCurrentTabAssets(undefined, selectedModalAsset);
        
        // Update preview in the current tab's form
        let previewIcon, previewName, playBtn;
        
        {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
        const activeTab = document.querySelector('.tab-pane.active');
        if (activeTab) {
            previewIcon = activeTab.querySelector('#selectedSoundIcon, [id^="selectedSoundIcon"]');
            previewName = activeTab.querySelector('#selectedSoundName, [id^="selectedSoundName"]');
            playBtn = activeTab.querySelector('#playSoundBtn, [id^="playSoundBtn"]');
        }
        {% else %}
        previewIcon = document.getElementById('selectedSoundIcon');
        previewName = document.getElementById('selectedSoundName');
        playBtn = document.getElementById('playSoundBtn');
        {% endif %}
        
        if (previewIcon && previewName && playBtn) {
            previewIcon.style.display = 'inline-block';
            previewName.textContent = selectedModalAsset.filename || 'Сонгосон дуу';
            playBtn.style.display = 'inline-block';
        }
    }
    
    // Update preview
    updatePreview();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('assetModal'));
    modal.hide();
}

function triggerFileUpload() {
    document.getElementById('modalFileUpload').click();
}

function uploadAssetFromModal(file) {
    if (!file) return;
    
    // Validate file
    const maxSize = currentModalType === 'gif' ? 35 * 1024 * 1024 : 5 * 1024 * 1024;
    if (file.size > maxSize) {
        alert(`Файлын хэмжээ хэтэрсэн байна. Хамгийн ихдээ ${maxSize / 1024 / 1024}MB байх ёстой.`);
        return;
    }
    
    const allowedTypes = currentModalType === 'gif' ? 
        ['image/gif', 'image/png', 'image/jpeg'] : 
        ['audio/mpeg', 'audio/wav', 'audio/ogg'];
    
    if (!allowedTypes.includes(file.type)) {
        alert('Зөвшөөрөгдөөгүй файлын төрөл байна.');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('asset_type', currentModalType);
    
    fetch('/donation-alert/upload-asset', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add to user assets
            if (currentModalType === 'gif') {
                window.userGifs = window.userGifs || [];
                window.userGifs.push(data.asset);
            } else {
                window.userSounds = window.userSounds || [];
                window.userSounds.push(data.asset);
            }
            
            // Reload user assets tab
            switchAssetTab('user');
            alert('Файл амжилттай нэмэгдлээ!');
        } else {
            alert('Алдаа: ' + data.error);
        }
    })
    .catch(error => {
        alert('Файл байршуулахад алдаа гарлаа.');
    });
}

function deleteModalAsset(event, assetId) {
    event.stopPropagation();
    
    if (!confirm('Та энэ файлыг устгахыг хүсэж байна уу?')) {
        return;
    }
    
    fetch(`/donation-alert/delete-asset/${assetId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove from local arrays
            if (currentModalType === 'gif') {
                window.userGifs = window.userGifs.filter(asset => asset.id !== assetId);
            } else {
                window.userSounds = window.userSounds.filter(asset => asset.id !== assetId);
            }
            
            // Reload user assets
            loadUserAssets();
            alert('Файл амжилттай устгагдлаа!');
        } else {
            alert('Алдаа: ' + data.error);
        }
    })
    .catch(error => {
        alert('Файл устгахад алдаа гарлаа.');
    });
}

// Global variable to track currently playing modal audio
let currentModalAudio = null;

function playModalSound(event, url) {
    event.stopPropagation();
    
    // Get the volume from the active form's volume slider
    let volumeSlider;
    
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    // Advanced tier - find active tab's volume slider
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        volumeSlider = activeTab.querySelector('#soundVolume, [id^="soundVolume"]');
    }
    {% else %}
    // Basic tier - use the main volume slider
    volumeSlider = document.getElementById('soundVolume');
    {% endif %}
    
    const volume = volumeSlider ? volumeSlider.value : 50;
    
    // Stop any currently playing modal audio
    if (currentModalAudio) {
        currentModalAudio.pause();
        currentModalAudio.currentTime = 0;
        currentModalAudio = null;
    }
    
    // Create and play new audio with correct volume
    currentModalAudio = new Audio(url);
    currentModalAudio.volume = volume / 100;
    
    // Clear reference when audio ends
    currentModalAudio.addEventListener('ended', () => {
        currentModalAudio = null;
    });
    
    currentModalAudio.play().catch(error => {
        currentModalAudio = null;
    });
}

function playSelectedSound() {
    const tabAssets = getCurrentTabAssets();
    const currentSound = tabAssets.selectedSound || selectedSound;
    
    if (currentSound && currentSound.url) {
        // Get the volume from the active form's volume slider
        let volumeSlider;
        
        {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
        // Advanced tier - find active tab's volume slider
        const activeTab = document.querySelector('.tab-pane.active');
        if (activeTab) {
            volumeSlider = activeTab.querySelector('#soundVolume, [id^="soundVolume"]');
        }
        {% else %}
        // Basic tier - use the main volume slider
        volumeSlider = document.getElementById('soundVolume');
        {% endif %}
        
        const volume = volumeSlider ? volumeSlider.value : 50;
        
        // Stop any currently playing audio
        if (currentModalAudio) {
            currentModalAudio.pause();
            currentModalAudio.currentTime = 0;
            currentModalAudio = null;
        }
        
        // Create and play new audio with correct volume
        currentModalAudio = new Audio(currentSound.url);
        currentModalAudio.volume = volume / 100;
        
        // Clear reference when audio ends
        currentModalAudio.addEventListener('ended', () => {
            currentModalAudio = null;
        });
        
        currentModalAudio.play().catch(error => {
            currentModalAudio = null;
        });
    }
}

function copyOverlayUrl(event) {
    // Generate the overlay URL using the current user's token
    const overlayToken = '{{ overlay_token }}';
    const baseUrl = window.location.origin;
    const url = `${baseUrl}/overlay/${overlayToken}`;
    
    navigator.clipboard.writeText(url).then(() => {
        // Show temporary success message
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Хуулагдлаа!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-primary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    });
}

// Global variable to track currently playing voice sample
let currentVoiceSample = null;
let currentVoiceButton = null;

// Voice Sample Playback Function
function playVoiceSample(voiceId) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    // Stop any currently playing voice sample
    if (currentVoiceSample) {
        currentVoiceSample.pause();
        currentVoiceSample.currentTime = 0;
        
        // Reset the previous button
        if (currentVoiceButton) {
            const prevBtn = currentVoiceButton;
            const prevText = prevBtn.getAttribute('data-original-text') || prevBtn.textContent;
            prevBtn.innerHTML = prevText;
            prevBtn.disabled = false;
        }
    }
    
    // Store original text for this button
    btn.setAttribute('data-original-text', originalText);
    
    // Disable button and show loading state
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Тоглож байна...';
    btn.disabled = true;
    
    // Get user's volume setting
    const volumeInput = document.getElementById('soundVolume');
    const volume = volumeInput ? volumeInput.value : 50;
    
    // Play the pre-recorded voice sample
    const audioUrl = `/static/assets/voice_models/${voiceId}_sample.wav`;
    const audio = new Audio(audioUrl);
    audio.volume = volume / 100;
    
    // Set as current playing sample
    currentVoiceSample = audio;
    currentVoiceButton = btn;
    
    audio.onloadeddata = () => {
        audio.play();
    };
    
    audio.onended = () => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        currentVoiceSample = null;
        currentVoiceButton = null;
    };
    
    audio.onerror = () => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        currentVoiceSample = null;
        currentVoiceButton = null;
        alert('Дуулгалт ачаалах боломжгүй байна');
    };
    
    // Auto-stop after 10 seconds as fallback
    setTimeout(() => {
        if (currentVoiceSample === audio && !audio.ended) {
            audio.pause();
            audio.currentTime = 0;
            btn.innerHTML = originalText;
            btn.disabled = false;
            currentVoiceSample = null;
            currentVoiceButton = null;
        }
    }, 10000);
}

// TTS Usage Display Function
function loadTTSUsage(buttonElement = null) {
    // Determine which tab we're working with
    let tabNumber = null;
    let suffix = '';
    
    if (buttonElement) {
        // Find the tab pane this button belongs to
        const tabPane = buttonElement.closest('.tab-pane');
        if (tabPane && tabPane.id) {
            tabNumber = parseInt(tabPane.id.replace('alert-', ''));
        }
    }
    
    if (tabNumber && tabNumber > 1) {
        suffix = '_tab' + tabNumber;
    }
    
    const displayDiv = document.getElementById('ttsUsageDisplay' + suffix);
    
    if (!displayDiv) {
        alert('TTS хэрэглээний мэдээлэл олдсонгүй');
        return;
    }
    
    if (displayDiv.style.display === 'none' || displayDiv.style.display === '') {
        // Load usage data
        fetch('/api/tts/usage')
        .then(response => response.json())
        .then(data => {
            // Update display with tab-specific elements
            const dailyUsageEl = document.getElementById('dailyUsage' + suffix);
            const dailyLimitEl = document.getElementById('dailyLimit' + suffix);
            const monthlyUsageEl = document.getElementById('monthlyUsage' + suffix);
            const monthlyLimitEl = document.getElementById('monthlyLimit' + suffix);
            
            if (dailyUsageEl) dailyUsageEl.textContent = data.daily.requests;
            if (dailyLimitEl) dailyLimitEl.textContent = data.daily.limit_requests;
            
            if (monthlyUsageEl) monthlyUsageEl.textContent = data.monthly.requests;
            if (monthlyLimitEl) monthlyLimitEl.textContent = data.monthly.limit_requests;
            
            displayDiv.style.display = 'block';
        })
        .catch(error => {
            alert('Хэрэглээний мэдээлэл ачаалж чадсангүй');
        });
    } else {
        displayDiv.style.display = 'none';
    }
}

// Form event listeners and submission handling
document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners for both basic and advanced tier forms
    function setupFormEventListeners() {
        // Find all forms (basic tier or tabs)
        const forms = document.querySelectorAll('form[id^="alertSettingsForm"]');
        
        forms.forEach(form => {
            // Skip if listeners already added (prevent duplicates)
            if (form.dataset.listenersAdded === 'true') {
                return;
            }
            
            // Add input and change listeners for real-time preview
            form.addEventListener('input', updatePreview);
            form.addEventListener('change', updatePreview);
            
            // Set up range display updates for this form
            setupRangeDisplaysForForm(form);
            
            // Mark as having listeners to prevent duplicates
            form.dataset.listenersAdded = 'true';
            
            // Add form submission listener
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Double safety check - ensure no default submission
                if (e.defaultPrevented === false) {
                    e.preventDefault();
                }
                
                {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
                // For advanced users: always save the current tab first, then handle any saved states
                
                // Save current active tab first
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab) {
                    const tabNumber = parseInt(activeTab.id.replace('alert-', ''));
                    
                    // Save current tab state before checking for unsaved states
                    formStateManager.saveTabState(tabNumber);
                    
                    // Now check if there are any saved states (including the one we just saved)
                    const hasUnsavedTabs = Object.keys(formStateManager.states).length > 0;
                    
                    if (hasUnsavedTabs) {
                        // Save all tabs that have unsaved changes
                        const submitBtn = activeTab.querySelector('button[type="submit"]');
                        saveAllTabsWithChanges(submitBtn);
                    } else {
                        // Fallback to single tab save
                        saveSingleTab(this);
                    }
                } else {
                    // No active tab found, use single save
                    saveSingleTab(this);
                }
                {% else %}
                // For basic users: save the single form
                saveSingleTab(this);
                {% endif %}
            });
        });
    }
    
    // Initial setup
    setupFormEventListeners();
    
    // Set up tab switching event handlers for form state preservation
    {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
    
    // Helper function to extract tab number from tab element
    function getTabNumberFromElement(element) {
        const targetId = element.getAttribute('data-bs-target') || element.getAttribute('aria-controls');
        if (targetId) {
            const match = targetId.match(/alert-(\d+)/);
            return match ? parseInt(match[1]) : null;
        }
        return null;
    }
    
    // Before leaving a tab - save its form state
    const tabButtons = document.querySelectorAll('#alertTabs .nav-link:not(.add-tab-btn)');
    tabButtons.forEach(tabButton => {
        // Mark existing tabs as having handlers to prevent duplicates
        tabButton.dataset.stateHandlersAdded = 'true';
        
        tabButton.addEventListener('hide.bs.tab', function(e) {
            const tabNumber = getTabNumberFromElement(e.target);
            if (tabNumber) {
                formStateManager.saveTabState(tabNumber);
            }
        });
    });
    
    // After entering a tab - restore its form state if it exists
    tabButtons.forEach(tabButton => {
        tabButton.addEventListener('shown.bs.tab', function(e) {
            const tabNumber = getTabNumberFromElement(e.target);
            if (tabNumber) {
                
                // Small delay to ensure tab content is fully rendered
                setTimeout(() => {
                    const wasRestored = formStateManager.restoreTabState(tabNumber);
                    if (wasRestored) {
                        // Update preview with restored data
                        updatePreview();
                    } else {
                    }
                }, 50);
            }
        });
    });
    
    {% endif %}
    
    // Re-setup when new tabs are added
    const originalAddNewAlertTab = window.addNewAlertTab;
    window.addNewAlertTab = function() {
        originalAddNewAlertTab.call(this);
        
        // Use requestAnimationFrame to ensure DOM is fully updated before adding listeners
        requestAnimationFrame(() => {
            setupFormEventListeners();
            
            {% if current_user.get_current_subscription() and current_user.get_current_subscription().feature_tier and current_user.get_current_subscription().feature_tier.value == 'advanced' %}
            // Add form state management event handlers to the new tab
            const newTabButtons = document.querySelectorAll('#alertTabs .nav-link:not(.add-tab-btn)');
            newTabButtons.forEach(tabButton => {
                // Check if handlers are already attached
                if (!tabButton.dataset.stateHandlersAdded) {
                    // Before leaving a tab - save its form state
                    tabButton.addEventListener('hide.bs.tab', function(e) {
                        const tabNumber = getTabNumberFromElement(e.target);
                        if (tabNumber) {
                                        formStateManager.saveTabState(tabNumber);
                        }
                    });
                    
                    // After entering a tab - restore its form state if it exists
                    tabButton.addEventListener('shown.bs.tab', function(e) {
                        const tabNumber = getTabNumberFromElement(e.target);
                        if (tabNumber) {
                                        
                            // Small delay to ensure tab content is fully rendered
                            setTimeout(() => {
                                const wasRestored = formStateManager.restoreTabState(tabNumber);
                                if (wasRestored) {
                                                // Update preview with restored data
                                    updatePreview();
                                } else {
                                            }
                            }, 50);
                        }
                    });
                    
                    // Mark handlers as added
                    tabButton.dataset.stateHandlersAdded = 'true';
                }
            });
            
            if (typeof setupMinimumAmountListeners === 'function') {
                setupMinimumAmountListeners();
            }
            {% endif %}
        });
    };
    
    // Add drag and drop functionality to upload area
    const uploadArea = document.getElementById('uploadArea');
    
    if (uploadArea) {
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadAssetFromModal(files[0]);
            }
        });
    }
    
    // Initial preview update after everything is loaded
    setTimeout(() => {
        updatePreview();
    }, 500);
});

// Add Socket.IO for real-time alert testing if available
if (typeof io !== 'undefined') {
    const userId = {{ current_user.id if current_user.is_authenticated else 'null' }};
    
    const socket = io();
    
    socket.on('connect', function() {
        // Socket connected
    });
    
    socket.on('disconnect', function() {
        // Socket disconnected
    });
}

// Initialize tooltip for basic tier add button and minimum amount tracking
document.addEventListener('DOMContentLoaded', function() {
    const basicTierAddBtn = document.getElementById('basicTierAddBtn');
    if (basicTierAddBtn && typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        new bootstrap.Tooltip(basicTierAddBtn, {
            trigger: 'hover focus',
            customClass: 'custom-tooltip',
            html: true
        });
    }
    
    // Update basic tier tab amount in real time
    const minimumAmountInput = document.getElementById('minimumAmount');
    const basicTabAmount = document.getElementById('basicTabAmount');
    
    if (minimumAmountInput && basicTabAmount) {
        // Set initial value
        const initialAmount = minimumAmountInput.value || 0;
        basicTabAmount.textContent = `₮${initialAmount}`;
        
        // Update on input change
        minimumAmountInput.addEventListener('input', function() {
            const amount = this.value || 0;
            basicTabAmount.textContent = `₮${amount}`;
        });
    }
});
</script>

{% endblock %}